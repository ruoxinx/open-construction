<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="theme-color" content="#0f2e4b">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenConstruction · Object Taxonomy</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- D3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <style>
    :root{
      --oc-bg:#ffffff; --oc-text:#1e2a36; --oc-subtle:#6b7b8c; --oc-border:#e7edf3;
      --oc-ink:#0f2e4b; --oc-accent:#f2a238; --oc-link:#0b66c3;
      --oc-card:#ffffff; --oc-shadow:0 8px 24px rgba(15,46,75,.06);
      --oc-radius:14px; --oc-muted:#f6f9fc; --oc-focus:#86b7fe;
    }
    html,body{ background:var(--oc-bg); color:var(--oc-text); }
    a{ color:var(--oc-link); }
    .oc-container{ max-width:1180px; }

    .oc-nav{ backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid var(--oc-border)!important; }
    .brand-wordmark{ display:flex; flex-direction:column; line-height:1; gap:0; align-items:flex-start; color:#0F2E4B; }
    .brand-wordmark .oc-open{ font-size:.75rem; font-weight:400; letter-spacing:.15em; text-transform:uppercase; opacity:.7; margin-bottom:-.1rem; }
    .brand-wordmark .oc-construction{ font-size:1.35rem; font-weight:700; letter-spacing:-.01em; }
    .oc-logo{ height:44px; width:44px; }
    .navbar .nav-link.plain{ font-weight:700; color:var(--oc-text); padding:.5rem .6rem; }
    .navbar .nav-link.plain:hover,.navbar .nav-link.plain.active{ color:var(--oc-ink); text-decoration:underline; text-underline-offset:3px; }
    .nav-link.icon-only{ line-height:1; padding-top:.375rem; padding-bottom:.375rem; }
    .nav-link.icon-only svg{ display:block; width:20px; height:20px; color:inherit; opacity:.9; }
    .nav-link.icon-only:hover svg{ opacity:1; }
    .btn-subscribe-icon{ background:transparent; border:0; padding:.25rem .4rem; line-height:1; }
    .btn-subscribe-icon svg{ fill:var(--oc-accent); }

    .hero{ background:#fff; border-bottom:1px solid var(--oc-border); }
    .hero .content{ padding:54px 0 34px; text-align:center; }
    .hero h1{
      font-weight:850; letter-spacing:.15px; line-height:1.12;
      font-size:clamp(1.7rem,1.1rem + 2.2vw,2.35rem);
      margin:.2rem 0 .35rem;
      color:var(--oc-ink);
    }
    .hero p.lead{ max-width:96ch; margin:0 auto; color:var(--oc-subtle); }
    .hl{ background:linear-gradient(180deg,transparent 60%,rgba(242,162,56,.25) 0); padding:0 .08em; font-weight:800; }

    .oc-section{ margin-top:26px; }
    .oc-kicker{ font-size:.8rem; letter-spacing:.18em; text-transform:uppercase; color:var(--oc-subtle); }

    .pane{
      border:1px solid var(--oc-border);
      border-radius:18px;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(11,102,195,.08), transparent 55%),
                  radial-gradient(900px 540px at 90% 20%, rgba(242,162,56,.10), transparent 55%),
                  linear-gradient(180deg, #ffffff, #fbfdff);
      box-shadow: 0 12px 30px rgba(15,46,75,.08);
      overflow:hidden;
    }
    .pane-head{
      padding:12px 14px;
      border-bottom:1px solid var(--oc-border);
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(6px);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .pane-title{ font-weight:900; color:var(--oc-ink); }
    .pane-sub{ color:var(--oc-subtle); font-size:.92rem; margin-top:2px; }

    /* Sticky toolbox in-flow (no overlay). Spacer keeps content from being covered. */
    .sticky-tools{
      position: sticky;
      top: 74px;
      z-index: 30;
      margin-top: 12px;
    }
    #toolboxSpacer{ height: 0px; }
    @media (max-width: 991.98px){
      .sticky-tools{ position: static; top:auto; }
      #toolboxSpacer{ height: 0px !important; }
    }

    .toolbox{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      border:1px solid var(--oc-border);
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(7px);
      box-shadow: 0 12px 26px rgba(15,46,75,.08);
      padding:10px 12px;
    }
    .toolbox .left{ display:flex; gap:10px; align-items:center; flex:1 1 auto; min-width: 260px; }
    .toolbox .right{ display:flex; gap:10px; align-items:center; flex:0 0 auto; flex-wrap:wrap; }
    .toolbox input{
      width: 100%;
      border:0; outline:none;
      background: transparent;
      padding: .2rem .2rem;
      color: var(--oc-ink);
      font-weight: 650;
    }
    .toolbox input::placeholder{ color: rgba(107,123,140,.85); font-weight: 600; }

    .btn-mini{
      border:1px solid rgba(15,46,75,.14);
      background:#fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 850;
      color: var(--oc-ink);
      box-shadow: 0 10px 22px rgba(15,46,75,.06);
      transition: transform .12s ease;
      white-space: nowrap;
    }
    .btn-mini:hover{ transform: translateY(-1px); }

    .control{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid rgba(15,46,75,.12);
      background: rgba(255,255,255,.9);
      border-radius: 999px;
      box-shadow: 0 10px 20px rgba(15,46,75,.05);
      font-weight:800;
      color:var(--oc-ink);
    }
    .control input[type="range"]{ width:120px; }

    .pane-body{ padding:14px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 14px;
      align-items: stretch;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .vizWrap{
      border:1px solid var(--oc-border);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 12px 26px rgba(15,46,75,.06);
      overflow:hidden;
      min-height: 72vh;
      position: relative;
    }
    .vizTopHint{
      position:absolute;
      left: 12px;
      top: 12px;
      z-index: 5;
      font-size: .9rem;
      font-weight: 850;
      color: var(--oc-ink);
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(15,46,75,.10);
      border-radius: 999px;
      padding: 6px 10px;
      backdrop-filter: blur(6px);
    }
    .vizTopHint span{ color: var(--oc-subtle); font-weight: 800; margin-left: 8px; }

    svg{ display:block; width:100%; height:100%; }

    .details{
      border:1px solid var(--oc-border);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 12px 26px rgba(15,46,75,.06);
      padding: 12px 12px 10px;
    }
    .details h3{ font-size: 1.05rem; margin: 2px 0 6px; font-weight: 950; color: var(--oc-ink); }
    .details .meta{ color: var(--oc-subtle); font-weight: 700; font-size: .92rem; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(15,46,75,.12);
      background: rgba(246,249,252,.85);
      border-radius: 999px;
      padding: 5px 9px;
      font-weight: 850;
      color: var(--oc-ink);
      margin: 3px 6px 0 0;
      font-size: .86rem;
    }
    .list-clean{ margin: 10px 0 0; padding-left: 1.1rem; color: var(--oc-text); }
    .muted{ color: var(--oc-subtle); }

    /* Radial label readability */
    .labelHalo{
      paint-order: stroke fill;
      stroke: rgba(255,255,255,.92);
      stroke-width: 3.8px;
      stroke-linejoin: round;
    }
    .catLabel{
      font-weight: 950;
      letter-spacing: .02em;
    }
    .termLabel{
      font-weight: 800;
    }
    .linkLine{
      fill: none;
      stroke: rgba(15,46,75,.16);
      stroke-width: 1.0px;
    }
    .nodeDot{
      stroke: rgba(15,46,75,.20);
      stroke-width: 1;
    }
    .highlight .termLabel,
    .highlight .catLabel{
      fill: #0b66c3 !important;
    }
    .dimmed{ opacity: .14; }

    .footer{
      border-top: 1px solid var(--oc-border);
      margin-top: 40px;
      padding: 18px 0 24px;
      color: var(--oc-subtle);
      font-weight: 650;
    }

    /* Fullscreen mode (visual polish) */
    .fs-on .vizWrap{
      position: fixed;
      inset: 16px;
      z-index: 9999;
      min-height: auto;
      height: calc(100vh - 32px);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15,46,75,.20);
    }
    .fs-on .fs-hide{ display:none !important; }
  </style>
</head>

<body>
  <!-- Top Nav -->
  <nav class="navbar navbar-expand-lg bg-white oc-nav sticky-top">
    <div class="container oc-container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <img src="/assets/img/icon.png" class="oc-logo" alt="OpenConstruction logo">
        <div class="brand-wordmark">
          <div class="oc-open">OPEN</div>
          <div class="oc-construction">Construction</div>
        </div>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#ocNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="ocNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link plain" href="/datasets/">Datasets</a></li>
          <li class="nav-item"><a class="nav-link plain" href="/models/">Models</a></li>
          <li class="nav-item"><a class="nav-link plain" href="/benchmarks.html">Benchmarks</a></li>
          <li class="nav-item"><a class="nav-link plain active" href="/object_taxonomy.html">Taxonomy</a></li>
          <li class="nav-item"><a class="nav-link plain" href="/contributors.html">Community</a></li>

          <!-- GitHub icon -->
          <li class="nav-item ms-lg-2">
            <a class="nav-link icon-only" href="https://github.com/openconstruction" target="_blank" rel="noopener" aria-label="OpenConstruction on GitHub">
              <svg viewBox="0 0 16 16" aria-hidden="true"><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
              0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21
              1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21
              2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15
              0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
            </a>
          </li>

          <!-- Subscribe icon -->
          <li class="nav-item">
            <a class="nav-link icon-only" href="/updates.xml" target="_blank" rel="noopener" aria-label="Subscribe RSS">
              <button class="btn-subscribe-icon" type="button" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24"><path d="M6.18 17.82a2.18 2.18 0 1 1 0 4.36 2.18 2.18 0 0 1 0-4.36ZM4 4.44v3.09c7.44 0 13.47 6.03 13.47 13.47h3.09C20.56 11.86 13.14 4.44 4 4.44Zm0 6.18v3.09c4.02 0 7.29 3.27 7.29 7.29h3.09c0-5.72-4.66-10.38-10.38-10.38Z"/></svg>
              </button>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero">
    <div class="container oc-container">
      <div class="content">
        <div class="oc-kicker mb-2">Controlled Vocabulary</div>
        <h1>Object / Class Taxonomy for <span class="hl">OpenConstruction</span></h1>
        <p class="lead">
          A SKOS-like, machine-readable vocabulary for object/class labels across the dataset catalog.
          This page emphasizes readability at scale: <strong>all categories and all leaf terms are rendered</strong>,
          and search can focus the view to any term to avoid “dense-map blindness”.
        </p>
      </div>
    </div>
  </header>

  <main class="container oc-container">

    <section class="oc-section">
      <div class="pane">
        <div class="pane-head">
          <div>
            <div class="pane-title">Radial Taxonomy Map</div>
            <div class="pane-sub">Pan/zoom the figure. Click a node to inspect synonyms and jump to example datasets.</div>
          </div>
          <div class="fs-hide">
            <button class="btn-mini" id="btnFullscreen" type="button" title="Fullscreen">Fullscreen</button>
          </div>
        </div>

        <div class="pane-body">

          <!-- Sticky toolbox (in-flow) -->
          <div class="sticky-tools">
            <div class="toolbox" id="toolbox">
              <div class="left">
                <span class="pill" title="Vocabulary source">object_vocab.json</span>
                <div style="flex:1 1 auto; min-width:220px;">
                  <input id="q" placeholder="Search objects/classes (prefLabel or synonyms)…" autocomplete="off">
                </div>
                <button class="btn-mini" id="btnClear" type="button">Clear</button>
                <button class="btn-mini" id="btnFocusFirst" type="button">Focus</button>
              </div>

              <div class="right">
                <div class="control" title="Increase/decrease leaf label font size">
                  Font <input id="fontRange" type="range" min="9" max="16" value="12">
                </div>
                <div class="control" title="Increase/decrease overall radius (spreads nodes)">
                  Radius <input id="radRange" type="range" min="380" max="820" value="640">
                </div>
                <button class="btn-mini" id="btnReset" type="button">Reset view</button>
              </div>
            </div>
            <div id="toolboxSpacer"></div>
          </div>

          <div class="grid mt-3">
            <div class="vizWrap" id="vizWrap">
              <div class="vizTopHint">Tip<span>Search → Focus to jump to the best match</span></div>
              <svg id="svg" aria-label="Object taxonomy radial map"></svg>
            </div>

            <aside class="details" id="details">
              <h3 id="dTitle">Select a term</h3>
              <div class="meta" id="dMeta">Click any category or leaf term in the figure.</div>

              <div class="mt-3">
                <div class="pill">Synonyms</div>
                <div id="dSyn" class="muted mt-2">—</div>
              </div>

              <div class="mt-3">
                <div class="pill">Broader</div>
                <div id="dBroader" class="muted mt-2">—</div>
              </div>

              <div class="mt-3">
                <div class="pill">Example datasets</div>
                <ul id="dExamples" class="list-clean muted">
                  <li>—</li>
                </ul>
              </div>

              <div class="mt-3 small muted">
                Why radial? Compared to a force-directed “ball of yarn”, a radial cluster yields stable label orientation,
                clearer category boundaries, and deterministic layout (important for a scientific controlled vocabulary).
              </div>
            </aside>
          </div>

        </div>
      </div>
    </section>

    <div class="footer">
      <div class="container oc-container">
        OpenConstruction · Object / Class Taxonomy (controlled vocabulary). Suggested citation: OpenConstruction Vocabulary, v1.0.
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ------------------------- helpers ------------------------- */
    const $ = (id) => document.getElementById(id);

    function normKey(s){
      return (s || "")
        .toLowerCase()
        .trim()
        .replace(/[“”"'`]/g,"")
        .replace(/[^a-z0-9\\s\\-/&]+/g," ")
        .replace(/\\s+/g," ")
        .trim();
    }

    function setSpacer(){
      const tb = $("toolbox");
      const sp = $("toolboxSpacer");
      if (!tb || !sp) return;
      // Always reserve vertical space so sticky never overlays content below.
      sp.style.height = (tb.offsetHeight + 12) + "px";
    }
    window.addEventListener("resize", setSpacer);

    function datasetDetailURL(id){
      return `/datasets/detail.html?id=${encodeURIComponent(id)}`;
    }

    /* ------------------------- state ------------------------- */
    let VOCAB = null;
    let conceptById = new Map();
    let termIndex = []; // searchable entries
    let matches = [];
    let firstMatchNode = null;

    // viz state
    let svg, gRoot, gLinks, gNodes, zoom;
    let width = 900, height = 900;
    let R = 640;
    let baseFont = 12;

    /* ------------------------- build hierarchy ------------------------- */
    function buildHierarchy(vocab){
      // Create a hierarchy rooted at oc:objects
      const nodes = new Map();
      vocab.concepts.forEach(c => nodes.set(c.id, {...c}));

      function childrenOf(id){
        const n = nodes.get(id);
        const kids = (n && n.narrower) ? n.narrower.slice() : [];
        return kids.filter(k => nodes.has(k)).map(k => nodes.get(k));
      }

      function build(id){
        const n = nodes.get(id);
        const kids = childrenOf(id).map(k => build(k.id));
        return { ...n, children: kids };
      }

      // Ensure "Other" exists in categories list and as category concept
      return build("oc:objects");
    }

    function isCategory(d){ return d.data && d.data.type === "Category"; }
    function isRoot(d){ return d.data && d.data.id === "oc:objects"; }

    /* ------------------------- radial layout ------------------------- */
    function renderRadial(rootData){
      const wrap = $("vizWrap");
      width = wrap.clientWidth;
      height = wrap.clientHeight;

      svg = d3.select("#svg")
        .attr("viewBox", [-(width/2), -(height/2), width, height])
        .attr("role","img");

      svg.selectAll("*").remove();

      gRoot = svg.append("g");

      // Zoom
      zoom = d3.zoom()
        .scaleExtent([0.28, 8])
        .on("zoom", (event) => gRoot.attr("transform", event.transform));

      svg.call(zoom);

      const root = d3.hierarchy(rootData);
      const cluster = d3.cluster()
        .size([2 * Math.PI, R]);

      cluster(root);

      // Helpers to map polar->cartesian
      const project = (a, r) => [Math.cos(a - Math.PI/2) * r, Math.sin(a - Math.PI/2) * r];

      // Links
      gLinks = gRoot.append("g").attr("aria-label","links");

      const linkGen = d3.linkRadial()
        .angle(d => d.x)
        .radius(d => d.y);

      const links = gLinks.selectAll("path")
        .data(root.links())
        .join("path")
        .attr("class","linkLine")
        .attr("d", linkGen);

      // Nodes
      gNodes = gRoot.append("g").attr("aria-label","nodes");

      const node = gNodes.selectAll("g")
        .data(root.descendants())
        .join("g")
        .attr("transform", d => {
          const [x,y] = project(d.x, d.y);
          return `translate(${x},${y})`;
        })
        .attr("data-id", d => d.data.id)
        .style("cursor","pointer")
        .on("click", (_, d) => onSelect(d))
        .on("dblclick", (_, d) => focusNode(d));

      node.append("circle")
        .attr("r", d => isRoot(d) ? 7 : (isCategory(d) ? 4.2 : 2.8))
        .attr("class","nodeDot")
        .attr("fill", d => isRoot(d) ? "rgba(15,46,75,.85)" : (isCategory(d) ? "rgba(242,162,56,.95)" : "rgba(11,102,195,.85)"));

      // Labels: always show ALL labels; use rotation so they read outward
      node.append("text")
        .attr("class", d => (isCategory(d) ? "catLabel labelHalo" : "termLabel labelHalo"))
        .attr("dy", "0.32em")
        .attr("font-size", d => {
          if (isRoot(d)) return Math.max(14, baseFont + 3);
          if (isCategory(d)) return Math.max(13, baseFont + 1);
          return baseFont;
        })
        .attr("text-anchor", d => (d.x < Math.PI) ? "start" : "end")
        .attr("transform", d => {
          const rot = (d.x * 180 / Math.PI) - 90;
          const flip = (d.x >= Math.PI) ? 180 : 0;
          const offset = isRoot(d) ? 14 : (isCategory(d) ? 12 : 9);
          return `rotate(${rot}) translate(${offset},0) rotate(${flip})`;
        })
        .attr("fill", d => {
          if (isRoot(d)) return "rgba(15,46,75,.95)";
          if (isCategory(d)) return "rgba(15,46,75,.92)";
          return "rgba(30,42,54,.90)";
        })
        .text(d => d.data.prefLabel || d.data.id);

      // keep a searchable index of leaf + category labels
      termIndex = root.descendants().map(d => ({
        id: d.data.id,
        key: normKey((d.data.prefLabel || "")),
        alts: (d.data.altLabels || []).map(normKey),
        node: d
      }));

      // start at a nice scale
      const initScale = Math.min(width, height) / (R * 2 + 240);
      svg.call(zoom.transform, d3.zoomIdentity.scale(Math.max(0.55, Math.min(0.95, initScale))));

      // stash for highlighting
      window.__OC_ROOT = root;
    }

    /* ------------------------- selection / details ------------------------- */
    function renderDetails(concept){
      $("dTitle").textContent = concept.prefLabel || concept.id;
      const cat = concept.category ? ` · Category: ${concept.category}` : "";
      const count = concept.stats && concept.stats.dataset_count != null ? ` · Appears in ${concept.stats.dataset_count} dataset(s)` : "";
      $("dMeta").textContent = `${concept.type || "Concept"}${cat}${count}`;

      const syn = (concept.altLabels && concept.altLabels.length) ? concept.altLabels : [];
      $("dSyn").innerHTML = syn.length ? syn.map(s => `<span class="pill">${escapeHTML(s)}</span>`).join(" ") : `<span class="muted">—</span>`;

      const broader = (concept.broader && concept.broader.length) ? concept.broader : [];
      if (broader.length){
        const labels = broader.map(id => conceptById.get(id)?.prefLabel || id);
        $("dBroader").innerHTML = labels.map(s => `<span class="pill">${escapeHTML(s)}</span>`).join(" ");
      } else {
        $("dBroader").innerHTML = `<span class="muted">—</span>`;
      }

      const examples = (concept.examples && concept.examples.datasets) ? concept.examples.datasets : [];
      const ul = $("dExamples");
      ul.innerHTML = "";
      if (!examples.length){
        ul.innerHTML = `<li>—</li>`;
      } else {
        examples.slice(0, 8).forEach(id => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${datasetDetailURL(id)}">${escapeHTML(id)}</a>`;
          ul.appendChild(li);
        });
      }
    }

    function onSelect(d){
      const concept = conceptById.get(d.data.id) || d.data;
      renderDetails(concept);
      highlightByIds(new Set([d.data.id]));
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    /* ------------------------- search + highlight + focus ------------------------- */
    function search(q){
      const qq = normKey(q);
      matches = [];
      firstMatchNode = null;

      if (!qq){
        clearHighlight();
        $("btnFocusFirst").disabled = true;
        return;
      }

      for (const item of termIndex){
        if (item.key.includes(qq) || item.alts.some(a => a.includes(qq))){
          matches.push(item);
        }
      }
      $("btnFocusFirst").disabled = matches.length === 0;

      // highlight all matches, but keep the map readable by dimming non-matches
      const idset = new Set(matches.map(m => m.id));
      highlightByIds(idset);

      // best match heuristic: prefer exact start match, then shorter label
      matches.sort((a,b) => {
        const aStart = a.key.startsWith(qq) ? 0 : 1;
        const bStart = b.key.startsWith(qq) ? 0 : 1;
        if (aStart !== bStart) return aStart - bStart;
        return a.key.length - b.key.length;
      });

      firstMatchNode = matches[0]?.node || null;
    }

    function highlightByIds(idset){
      const nodes = d3.select("#svg").selectAll("g[data-id]");
      nodes.classed("highlight", d => idset.has(d.data.id));
      nodes.classed("dimmed", d => idset.size && !idset.has(d.data.id));
    }

    function clearHighlight(){
      const nodes = d3.select("#svg").selectAll("g[data-id]");
      nodes.classed("highlight", false);
      nodes.classed("dimmed", false);
    }

    function focusNode(d){
      // zoom to node: translate node to center and scale up a bit
      const wrap = $("vizWrap");
      const w = wrap.clientWidth, h = wrap.clientHeight;

      const t = d3.zoomTransform(d3.select("#svg").node());
      const pt = d3.pointer({clientX:0, clientY:0}, d3.select("#svg").node()); // not used

      const nodeEl = d3.select(`g[data-id="${CSS.escape(d.data.id)}"]`).node();
      if (!nodeEl) return;

      // Get node position in current SVG coordinate system:
      const m = nodeEl.getCTM();
      // m.e, m.f are in screen coords, but we can use getBBox + transform logic:
      // simpler: compute node position from data again
      const root = window.__OC_ROOT;
      const project = (a, r) => [Math.cos(a - Math.PI/2) * r, Math.sin(a - Math.PI/2) * r];
      const [nx, ny] = project(d.x, d.y);

      const scale = Math.max(1.2, Math.min(4.0, t.k * 1.6));
      const tx = -nx * scale;
      const ty = -ny * scale;

      const target = d3.zoomIdentity.translate(tx, ty).scale(scale);

      d3.select("#svg")
        .transition()
        .duration(520)
        .call(zoom.transform, target);

      // update details too
      onSelect(d);
    }

    function resetView(){
      const wrap = $("vizWrap");
      width = wrap.clientWidth;
      height = wrap.clientHeight;
      const initScale = Math.min(width, height) / (R * 2 + 240);
      d3.select("#svg")
        .transition()
        .duration(520)
        .call(zoom.transform, d3.zoomIdentity.scale(Math.max(0.55, Math.min(0.95, initScale))));
      clearHighlight();
    }

    /* ------------------------- load vocab + init ------------------------- */
    async function init(){
      setSpacer();

      // Load controlled vocabulary (generated file)
      const res = await fetch("/site/data/object_vocab.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Could not load /site/data/object_vocab.json");
      VOCAB = await res.json();

      // Build lookup
      VOCAB.concepts.forEach(c => conceptById.set(c.id, c));

      const rootData = buildHierarchy(VOCAB);
      renderRadial(rootData);

      // wire UI
      $("q").addEventListener("input", (e) => search(e.target.value));
      $("btnClear").addEventListener("click", () => {
        $("q").value = "";
        search("");
      });
      $("btnFocusFirst").addEventListener("click", () => {
        if (firstMatchNode) focusNode(firstMatchNode);
      });
      $("btnReset").addEventListener("click", resetView);

      $("fontRange").addEventListener("input", (e) => {
        baseFont = parseInt(e.target.value, 10);
        renderRadial(buildHierarchy(VOCAB));
        // reapply search highlight if needed
        const q = $("q").value;
        if (q) search(q);
        setSpacer();
      });
      $("radRange").addEventListener("input", (e) => {
        R = parseInt(e.target.value, 10);
        renderRadial(buildHierarchy(VOCAB));
        const q = $("q").value;
        if (q) search(q);
        setSpacer();
      });

      // Fullscreen
      $("btnFullscreen").addEventListener("click", () => {
        document.body.classList.toggle("fs-on");
        setTimeout(() => {
          renderRadial(buildHierarchy(VOCAB));
          const q = $("q").value;
          if (q) search(q);
          setSpacer();
        }, 40);
      });

      $("btnFocusFirst").disabled = true;

      // initial detail
      renderDetails(conceptById.get("oc:objects"));
    }

    init().catch(err => {
      console.error(err);
      $("dTitle").textContent = "Error";
      $("dMeta").textContent = err.message || String(err);
    });
  </script>
</body>
</html>

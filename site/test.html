<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="theme-color" content="#0f2e4b">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenConstruction · Object Taxonomy</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- D3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <style>
    :root{
      --oc-bg:#ffffff; --oc-text:#1e2a36; --oc-subtle:#6b7b8c; --oc-border:#e7edf3;
      --oc-ink:#0f2e4b; --oc-accent:#f2a238; --oc-link:#0b66c3;
      --oc-card:#ffffff; --oc-shadow:0 8px 24px rgba(15,46,75,.06);
      --oc-radius:14px; --oc-muted:#f6f9fc; --oc-focus:#86b7fe;
    }
    html,body{ background:var(--oc-bg); color:var(--oc-text); }
    a{ color:var(--oc-link); }
    .oc-container{ max-width:1180px; }

    /* keep site look consistent */
    .oc-nav{ backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid var(--oc-border)!important; }
    .brand-wordmark{ display:flex; flex-direction:column; line-height:1; gap:0; align-items:flex-start; color:#0F2E4B; }
    .brand-wordmark .oc-open{ font-size:.75rem; font-weight:400; letter-spacing:.15em; text-transform:uppercase; opacity:.7; margin-bottom:-.1rem; }
    .brand-wordmark .oc-construction{ font-size:1.35rem; font-weight:700; letter-spacing:-.01em; }
    .oc-logo{ height:44px; width:44px; }
    .navbar .nav-link.plain{ font-weight:700; color:var(--oc-text); padding:.5rem .6rem; }
    .navbar .nav-link.plain:hover,.navbar .nav-link.plain.active{ color:var(--oc-ink); text-decoration:underline; text-underline-offset:3px; }
    .nav-link.icon-only{ line-height:1; padding-top:.375rem; padding-bottom:.375rem; }
    .nav-link.icon-only svg{ display:block; width:20px; height:20px; color:inherit; opacity:.9; }
    .nav-link.icon-only:hover svg{ opacity:1; }
    .btn-subscribe-icon{ background:transparent; border:0; padding:.25rem .4rem; line-height:1; }
    .btn-subscribe-icon svg{ fill:var(--oc-accent); }

    .hero{ background:#fff; border-bottom:1px solid var(--oc-border); }
    .hero .content{ padding:54px 0 34px; text-align:center; }
    .hero h1{
      font-weight:850; letter-spacing:.15px; line-height:1.12;
      font-size:clamp(1.7rem,1.1rem + 2.2vw,2.35rem);
      margin:.2rem 0 .35rem;
      color:var(--oc-ink);
    }
    .hero p.lead{ max-width:92ch; margin:0 auto; color:var(--oc-subtle); }
    .hl{ background:linear-gradient(180deg,transparent 60%,rgba(242,162,56,.25) 0); padding:0 .08em; font-weight:800; }

    .oc-section{ margin-top:26px; }
    .oc-kicker{ font-size:.8rem; letter-spacing:.18em; text-transform:uppercase; color:var(--oc-subtle); }

    .oc-card{ background:var(--oc-card); border:1px solid var(--oc-border); border-radius:var(--oc-radius); box-shadow:var(--oc-shadow); }
    .oc-card-body{ padding:1.1rem 1.15rem; }

    /* Fancy layout */
    .pane{
      border:1px solid var(--oc-border);
      border-radius:18px;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(11,102,195,.08), transparent 55%),
                  radial-gradient(900px 540px at 90% 20%, rgba(242,162,56,.10), transparent 55%),
                  linear-gradient(180deg, #ffffff, #fbfdff);
      box-shadow: 0 12px 30px rgba(15,46,75,.08);
      overflow:hidden;
    }
    .pane-head{
      padding:12px 14px;
      border-bottom:1px solid var(--oc-border);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pane-title{ font-weight:900; color:var(--oc-ink); }
    .pane-sub{ color:var(--oc-subtle); font-size:.92rem; margin-top:2px; }
    .pane-body{ padding:14px; }

    .sticky-tools{
      position: sticky;
      top: 74px;
      z-index: 20;
    }

    .toolbox{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      border:1px solid var(--oc-border);
      border-radius: 999px;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(7px);
      box-shadow: 0 12px 26px rgba(15,46,75,.08);
      padding:10px 12px;
    }
    .toolbox .left{ display:flex; gap:10px; align-items:center; flex:1 1 auto; min-width: 260px; }
    .toolbox .right{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }
    .toolbox input{
      width: 100%;
      border:0;
      outline:none;
      background: transparent;
      padding: .2rem .2rem;
      color: var(--oc-ink);
      font-weight: 650;
    }
    .toolbox input::placeholder{ color: rgba(107,123,140,.85); font-weight: 600; }

    .btn-mini{
      border:1px solid rgba(15,46,75,.14);
      background:#fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 850;
      color: var(--oc-ink);
      box-shadow: 0 10px 22px rgba(15,46,75,.06);
      transition: transform .12s ease;
      white-space: nowrap;
    }
    .btn-mini:hover{ transform: translateY(-1px); }

    .legend{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      color: var(--oc-subtle);
      font-size: .9rem;
    }
    .legend .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block;
      background: var(--oc-accent);
      box-shadow: 0 8px 18px rgba(242,162,56,.18);
      margin-right:6px;
    }
    .legend code{ color: var(--oc-ink); font-weight: 800; }

    /* Viz */
    .viz-wrap{
      height: 680px;
      border-radius: 18px;
      border:1px solid var(--oc-border);
      overflow:hidden;
      position: relative;
      background: radial-gradient(800px 520px at 50% 50%, rgba(15,46,75,.06), transparent 60%);
    }
    .viz-hud{
      position:absolute;
      top:12px; left:12px; right:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      pointer-events:none;
    }
    .hud-pill{
      pointer-events:auto;
      border:1px solid var(--oc-border);
      border-radius: 999px;
      padding: 7px 10px;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
      color: var(--oc-subtle);
      font-weight: 750;
      box-shadow: 0 12px 26px rgba(15,46,75,.08);
      display:flex; align-items:center; gap:10px;
      white-space: nowrap;
    }
    .hud-pill strong{ color: var(--oc-ink); }
    .hud-pill .sep{ opacity:.45; }

    /* D3 styling */
    .link{
      fill:none;
      stroke: rgba(15,46,75,.16);
      stroke-width: 1.2px;
    }
    .node circle{
      fill: rgba(255,255,255,.94);
      stroke: rgba(15,46,75,.30);
      stroke-width: 1.5px;
      filter: drop-shadow(0 10px 22px rgba(15,46,75,.10));
    }
    .node text{
      font-size: 12px;
      font-weight: 760;
      fill: var(--oc-ink);
    }
    .node .label-sub{
      font-size: 10.5px;
      font-weight: 800;
      fill: rgba(107,123,140,.95);
    }
    /* leaf labels: slightly smaller + cleaner */
    .node .leaf-label{
      font-size: 11px;
      font-weight: 780;
      fill: rgba(15,46,75,.92);
      paint-order: stroke;
      stroke: rgba(255,255,255,.92);
      stroke-width: 3px;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .node--active circle{
      stroke: rgba(11,102,195,.9);
      stroke-width: 2.8px;
    }
    .node--active text{
      fill: rgba(11,102,195,1);
    }
    .ring{
      fill:none;
      stroke: rgba(242,162,56,.55);
      stroke-width: 3px;
      stroke-dasharray: 7 6;
      opacity: 0;
    }

    /* Inspector */
    .muted-box{
      background: rgba(246,249,252,.78);
      border:1px solid var(--oc-border);
      border-radius: 16px;
      padding: 12px 14px;
      color: var(--oc-subtle);
    }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 10px 12px;
      color: var(--oc-subtle);
      font-size: .95rem;
    }
    .kv strong{ color: var(--oc-ink); }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip{
      border:1px solid var(--oc-border);
      background: rgba(255,255,255,.92);
      border-radius:999px;
      padding:.35rem .65rem;
      font-weight:850;
      font-size:.86rem;
      color: var(--oc-ink);
      box-shadow: 0 10px 22px rgba(15,46,75,.06);
    }
    .chip a{ text-decoration:none; color: inherit; }

    .issue-btn{
      position:fixed; right:18px; bottom:18px;
      background:#0f2e4b; color:#fff;
      text-decoration:none;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 14px 30px rgba(15,46,75,.18);
      z-index:99;
    }
    .issue-btn:hover{ transform:translateY(-1px); color:#fff; }

    footer{ border-top:1px solid var(--oc-border); margin-top:44px; padding:18px 0; color:var(--oc-subtle); font-size:.95rem; }
    :focus-visible{ outline:2px solid var(--oc-focus); outline-offset:2px; border-radius:6px; }

    @media (max-width: 991.98px){
      .viz-wrap{ height: 560px; }
      .kv{ grid-template-columns: 120px 1fr; }
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-white sticky-top oc-nav">
    <div class="container oc-container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img src="assets/img/icon.png" alt="OpenConstruction logo" class="oc-logo">
        <span class="brand-wordmark">
          <span class="oc-open">OpenConstruction</span>
          <span class="oc-construction">Open Science</span>
        </span>
      </a>

      <button class="navbar-toggler ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExample">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-2">
          <li class="nav-item"><a class="nav-link plain" href="index.html" data-route="index">Home</a></li>

          <li class="nav-item dropdown">
            <a class="nav-link plain dropdown-toggle" href="#" id="ddProducts" role="button" data-bs-toggle="dropdown" aria-expanded="false">Products</a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="ddProducts">
              <li><a class="dropdown-item" href="dataset.html">Datasets</a></li>
              <li><a class="dropdown-item" href="models.html">Models</a></li>
              <li><a class="dropdown-item" href="deployments.html">Workflows</a></li>
              <li><a class="dropdown-item" href="oer.html">OERs</a></li>
            </ul>
          </li>

          <li class="nav-item"><a class="nav-link plain" href="schema.html" data-route="schema">Schema</a></li>
          <li class="nav-item"><a class="nav-link plain" href="benchmarks.html" data-route="benchmarks">Benchmarks</a></li>
          <li class="nav-item"><a class="nav-link plain active" href="object_taxonomy.html" aria-current="page">Taxonomy</a></li>

          <li class="nav-item"><a class="nav-link plain" href="contribute.html" data-route="contribute">Contribute</a></li>
          <li class="nav-item"><a class="nav-link plain" href="contributors.html" data-route="contributors">Community</a></li>

          <li class="nav-item">
            <a class="nav-link px-2 icon-only" href="https://github.com/ruoxinx/open-construction" target="_blank" rel="noopener"
               aria-label="OpenConstruction on GitHub" title="View on GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                   viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
                         0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
                         0-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95
                         0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.65 7.65 0 0 1 2-.27c.68 0
                         1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15
                         0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013
                         8.013 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
              </svg>
            </a>
          </li>

          <li class="nav-item">
            <button type="button" class="nav-link px-2 icon-only btn-subscribe-icon"
                    data-bs-toggle="modal" data-bs-target="#subscribeModal"
                    aria-label="Subscribe for updates" title="Subscribe">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                   viewBox="0 0 16 16" aria-hidden="true" class="icon-bell">
                <path d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16zm.5-14a.5.5 0 0
                         0-1 0 7 7 0 0 0-5.468 6.37c-.084.58-.272 1.204-.653 1.856-.356.617-.879 1.104-1.379
                         1.357V13h14v-1.417c-.5-.253-1.023-.74-1.379-1.357-.38-.652-.569-1.276-.653-1.856A7
                         7 0 0 0 8.5 2z"/>
              </svg>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <div class="container oc-container content">
      <div class="oc-kicker mb-2">Controlled Vocabulary</div>
      <h1>Object / Class Taxonomy Map</h1>
      <p class="lead">
        A <span class="hl">radial taxonomy</span> derived from dataset label spaces (<code>classes</code> in <code>data/datasets.json</code>).
        Node size reflects <strong>coverage</strong> (#datasets containing the class).
      </p>
    </div>
  </header>

  <main class="container oc-container">
    <!-- Tools -->
    <section class="oc-section sticky-tools">
      <div class="toolbox">
        <div class="left">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
               viewBox="0 0 16 16" aria-hidden="true" style="opacity:.75;">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
          </svg>
          <input id="q" type="search" placeholder="Search objects (e.g., worker, crane, crack, rebar, hard hat)">
        </div>
        <div class="right">
          <button class="btn-mini" id="btnReset" type="button">Reset view</button>
          <button class="btn-mini" id="btnExport" type="button">Export CSV</button>
        </div>
      </div>
      <div class="legend mt-2">
        <span><span class="dot"></span>Node size ∝ <code>#datasets</code></span>
        <span>·</span>
        <span>Click nodes to inspect aliases & evidence</span>
        <span>·</span>
        <span><code>Shift</code> + scroll to zoom</span>
        <span>·</span>
        <span><strong>Tip:</strong> leaf labels appear when zoomed in, or when a leaf is selected</span>
      </div>
    </section>

    <!-- Main -->
    <section class="oc-section">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="pane">
            <div class="pane-head">
              <div>
                <div class="pane-title">Radial map</div>
                <div class="pane-sub" id="subtitle">Loading…</div>
              </div>
              <div class="hud-pill">
                <span><strong id="statDS">—</strong> datasets</span><span class="sep">·</span>
                <span><strong id="statCanon">—</strong> canonical classes</span>
              </div>
            </div>
            <div class="pane-body">
              <div class="viz-wrap" id="viz">
                <div class="viz-hud">
                  <div class="hud-pill" id="hudLeft">Tip: click a node</div>
                  <div class="hud-pill" id="hudRight">Zoom: <strong id="zoomLvl">1.0×</strong></div>
                </div>
              </div>
              <div class="text-muted small mt-2">
                Canonicalization merges surface variants (case, hyphen/underscore, plural) and selected aliases. Extend rules in <code>TERM_ALIASES</code>.
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="pane h-100">
            <div class="pane-head">
              <div>
                <div class="pane-title">Inspector</div>
                <div class="pane-sub">Canonical term + evidence</div>
              </div>
            </div>
            <div class="pane-body">
              <div class="muted-box" id="insDef">
                Select any node in the radial map to see its canonical key, merged aliases, and dataset evidence.
              </div>

              <hr class="my-3">

              <div class="kv">
                <div><strong>Canonical key</strong></div><div id="insKey">—</div>
                <div><strong>Display label</strong></div><div id="insLabel">—</div>
                <div><strong>Category</strong></div><div id="insCat">—</div>
                <div><strong>Coverage</strong></div><div id="insCov">—</div>
              </div>

              <div class="mt-3">
                <div class="text-muted small"><strong>Aliases merged</strong></div>
                <div class="chips" id="insAliases"></div>
              </div>

              <div class="mt-3">
                <div class="text-muted small"><strong>Example datasets</strong></div>
                <div class="chips" id="insDS"></div>
              </div>

              <div class="mt-3">
                <a class="chip" id="insPermalink" href="object_class.html" style="text-decoration:none;">Open permalink</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="py-4 mt-3">
      <div class="container oc-container small text-muted text-center">
        <div>© <span id="yearNow"></span> OpenConstruction Open Science Initiative</div>
        <div class="mt-2">
          <small>
            <strong>Disclaimer:</strong> OpenConstruction indexes publicly accessible research metadata and provides
            links to original sources. We do not host or distribute datasets, models, code or paywalled content.
            All rights remain with the original authors, creators and publishers.
          </small>
        </div>
      </div>
    </footer>
  </main>

  <a href="https://github.com/ruoxinx/open-construction/issues/new?template=suggestion.yml"
     class="issue-btn" target="_blank" rel="noopener">
    Issue or Suggestion?
  </a>

  <!-- Subscribe modal (keep your existing action if you already have it) -->
  <div class="modal fade" id="subscribeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:420px;">
      <div class="modal-content p-3 rounded-3 shadow">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="m-0 fw-semibold">Subscribe</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="https://github.us5.list-manage.com/subscribe/post?u=12fa0b9a59e8110ba3a89fc76&amp;id=696e3eb0b3&amp;f_id=006fbeedf0"
              method="post" target="_blank" novalidate>
          <label for="sub-email" class="form-label small text-muted mb-1">Email</label>
          <input type="email" id="sub-email" name="EMAIL" class="form-control mb-2" placeholder="you@university.edu" required>
          <button type="submit" class="btn btn-primary w-100 mt-2">Subscribe</button>
          <div style="position:absolute; left:-5000px" aria-hidden="true">
            <input type="text" name="b_12fa0b9a59e8110ba3a89fc76_696e3eb0b3" tabindex="-1" value="">
          </div>
          <p class="small text-muted mt-2 mb-0">We’ll email only when new datasets or models are added. Unsubscribe anytime.</p>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById('yearNow').textContent = new Date().getFullYear();

    // ---------- utilities ----------
    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

    const normArray = (v) => Array.isArray(v) ? v.filter(Boolean) : (v ? [v] : []);
    const normStr = (v) => (v == null ? '' : String(v).trim());

    function canonKey(s){
      return normStr(s).toLowerCase()
        .replace(/[_/]+/g,' ')
        .replace(/-+/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }

    function singularize(key){
      const t = canonKey(key);
      if(t.endsWith('ies') && t.length > 4) return t.slice(0,-3) + 'y';
      if(t.endsWith('s') && !t.endsWith('ss') && t.length > 3) return t.slice(0,-1);
      return t;
    }

    function niceLabel(key){
      const raw = normStr(key);
      if(!raw) return '';
      // preserve short acronyms
      if(/[A-Z]/.test(raw) && raw.length <= 16) return raw;
      return raw.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    }

    // Alias mapping (extend over time)
    const TERM_ALIASES = new Map([
      ['hardhat','hard hat'],
      ['helmet','hard hat'],
      ['hi vis vest','reflective vest'],
      ['safety vest','reflective vest'],
      ['people','worker'],
      ['person','worker'],
      ['construction worker','worker'],
      ['rebar','reinforcing bar'],
      ['reinforcement bar','reinforcing bar'],
      ['dumptruck','dump truck'],
      ['dump-truck','dump truck'],
      ['cones','traffic cone'],
      ['cracks','crack'],
      ['spalling','spall'],
    ]);

    function applyAliasMerge(raw){
      const k = canonKey(raw);
      const v = TERM_ALIASES.get(k);
      return v ? canonKey(v) : k;
    }

    // Category inference (for top-level taxonomy branches)
    const CATEGORIES = [
      { id:'People', re:/\b(worker|person|people|human|inspector|operator|foreman)\b/ },
      { id:'Equipment & Vehicles', re:/\b(crane|excavator|bulldozer|loader|forklift|truck|dump truck|mixer|roller|grader|drone|uav|robot)\b/ },
      { id:'PPE & Safety', re:/\b(hard hat|reflective vest|vest|glove|goggle|mask|respirator|harness|traffic cone|barricade|barrier|sign)\b/ },
      { id:'Materials', re:/\b(concrete|cement|asphalt|steel|reinforcing bar|brick|wood|timber|glass|gypsum|drywall|insulation|soil|gravel|sand)\b/ },
      { id:'Structural Components', re:/\b(beam|column|slab|girder|truss|joist|foundation|pile|pier|wall|deck)\b/ },
      { id:'MEP Components', re:/\b(pipe|duct|hvac|valve|pump|cable|wire|panel|conduit|sprinkler|outlet|switch|meter)\b/ },
      { id:'Site & Temporary Works', re:/\b(scaffold|scaffolding|formwork|shoring|fence|road|lane|curb|site|stockpile|container|pallet)\b/ },
      { id:'Defects & Damage', re:/\b(crack|spall|corrosion|rust|delamination|pothole|defect|damage|leak)\b/ }
    ];

    function inferCategory(canon){
      const s = canonKey(canon);
      for(const c of CATEGORIES){
        if(c.re.test(s)) return c.id;
      }
      return 'Other / Unclassified';
    }

    async function loadDatasets(){
      const res = await fetch('data/datasets.json', { cache:'no-store' });
      if(!res.ok) throw new Error('Cannot load data/datasets.json');
      const raw = await res.json();
      const arr = Array.isArray(raw) ? raw : Object.values(raw || {});
      return arr.filter(Boolean);
    }

    function buildIndex(datasets){
      // canon -> record
      const idx = new Map();
      let rawCount = 0;

      for(const ds of datasets){
        const dsId = ds.id || ds.name || '(unknown)';
        const classes = normArray(ds.classes);
        for(const raw of classes){
          rawCount += 1;
          const merged = applyAliasMerge(raw);
          const canon = singularize(merged);
          if(!canon) continue;

          if(!idx.has(canon)){
            idx.set(canon, {
              canon,
              label: niceLabel(canon),
              category: inferCategory(canon),
              rawSet: new Set(),
              dsSet: new Set(),
              mentions: 0
            });
          }
          const rec = idx.get(canon);
          rec.rawSet.add(normStr(raw));
          rec.dsSet.add(dsId);
          rec.mentions += 1;
        }
      }

      return { idx, rawCount };
    }

    function buildHierarchy(idx){
      // Root -> categories -> items
      const root = { name:'Objects', id:'root', children:[] };

      const byCat = new Map();
      for(const rec of idx.values()){
        const cat = rec.category || 'Other / Unclassified';
        if(!byCat.has(cat)) byCat.set(cat, []);
        byCat.get(cat).push(rec);
      }

      // stable ordering
      const catOrder = CATEGORIES.map(x=>x.id).concat(['Other / Unclassified']);
      const cats = Array.from(byCat.keys()).sort((a,b)=>catOrder.indexOf(a)-catOrder.indexOf(b));

      for(const cat of cats){
        const items = byCat.get(cat).sort((a,b)=>{
          const da=a.dsSet.size, db=b.dsSet.size;
          if(db!==da) return db-da;
          return (a.label||a.canon).localeCompare(b.label||b.canon);
        });

        root.children.push({
          name: cat,
          id: 'cat:' + cat,
          children: items.map(r => ({
            name: r.label || r.canon,
            id: 'obj:' + r.canon,
            canon: r.canon,
            label: r.label || r.canon,
            category: r.category,
            coverage: r.dsSet.size,
            mentions: r.mentions,
            aliases: Array.from(r.rawSet),
            datasets: Array.from(r.dsSet)
          }))
        });
      }

      return root;
    }

    // --------- D3 Radial cluster ----------
    function renderRadial(rootData){
      const container = document.getElementById('viz');
      container.querySelector('svg')?.remove();

      const W = container.clientWidth;
      const H = container.clientHeight;
      const R = Math.min(W, H) / 2 - 24;

      const svg = d3.select(container).append('svg')
        .attr('width', W)
        .attr('height', H);

      const g = svg.append('g')
        .attr('transform', `translate(${W/2},${H/2})`);

      // Zoom
      const zoom = d3.zoom()
        .scaleExtent([0.55, 3.0])
        .on('zoom', (ev) => {
          g.attr('transform', `translate(${W/2},${H/2}) scale(${ev.transform.k}) translate(${ev.transform.x/ev.transform.k},${ev.transform.y/ev.transform.k})`);
          document.getElementById('zoomLvl').textContent = `${ev.transform.k.toFixed(2)}×`;
          updateLeafVisibility(ev.transform.k);
        });

      svg.call(zoom).on("wheel.zoom", null); // disable default wheel zoom
      // SHIFT + wheel for zoom
      svg.on("wheel", (ev) => {
        if(!ev.shiftKey) return;
        ev.preventDefault();
        const delta = -ev.deltaY * 0.002;
        const t = d3.zoomTransform(svg.node());
        const k = Math.max(0.55, Math.min(3.0, t.k * (1 + delta)));
        svg.transition().duration(80).call(zoom.scaleTo, k);
      }, { passive:false });

      const root = d3.hierarchy(rootData);
      const cluster = d3.cluster().size([2 * Math.PI, R]);
      cluster(root);

      // Coverage scale for leaf nodes
      const coverages = [];
      root.leaves().forEach(n => coverages.push(n.data.coverage || 0));
      const maxCov = Math.max(1, d3.max(coverages));
      const radiusScale = d3.scaleSqrt().domain([0, maxCov]).range([3.8, 10.5]);

      g.append('g')
        .selectAll('path')
        .data(root.links())
        .join('path')
        .attr('class', 'link')
        .attr('d', d3.linkRadial()
          .angle(d => d.x)
          .radius(d => d.y)
        );

      const node = g.append('g')
        .selectAll('g')
        .data(root.descendants())
        .join('g')
        .attr('class', 'node')
        .attr('transform', d => `rotate(${d.x * 180/Math.PI - 90}) translate(${d.y},0)`);

      node.append('circle')
        .attr('r', d => d.children ? (d.depth===0 ? 8.5 : 6.6) : radiusScale(d.data.coverage || 0));

      // --- Progressive disclosure labels (IMPORTANT) ---
      // 1) Category/root labels always visible
      node.filter(d => d.children).append('text')
        .attr('dy', '0.32em')
        .attr('x', d => d.x < Math.PI ? 12 : -12)
        .attr('text-anchor', d => d.x < Math.PI ? 'start' : 'end')
        .attr('transform', d => d.x >= Math.PI ? 'rotate(180)' : null)
        .text(d => (d.depth === 0 ? 'Objects' : d.data.name));

      // 2) Leaf labels are zoom/selection controlled
      const leafLabel = node.filter(d => !d.children).append('text')
        .attr('class','leaf-label')
        .attr('dy', '0.32em')
        .attr('x', d => d.x < Math.PI ? 12 : -12)
        .attr('text-anchor', d => d.x < Math.PI ? 'start' : 'end')
        .attr('transform', d => d.x >= Math.PI ? 'rotate(180)' : null)
        .text(d => d.data.name);

      const leafSub = node.filter(d => !d.children).append('text')
        .attr('class','label-sub')
        .attr('dy', '1.65em')
        .attr('x', d => d.x < Math.PI ? 12 : -12)
        .attr('text-anchor', d => d.x < Math.PI ? 'start' : 'end')
        .attr('transform', d => d.x >= Math.PI ? 'rotate(180)' : null)
        .text(d => `${d.data.coverage} ds`);

      // Highlight ring (animated)
      const ring = g.append('circle')
        .attr('class','ring')
        .attr('r', 14);

      let selectedCanon = null;

      function updateLeafVisibility(k){
        // Hide leaf labels by default; show when zoomed in or selected
        const showByZoom = k >= 1.55;

        leafLabel.style('display', d => {
          if (selectedCanon && d.data.canon === selectedCanon) return 'block';
          return showByZoom ? 'block' : 'none';
        });

        leafSub.style('display', d => {
          if (selectedCanon && d.data.canon === selectedCanon) return 'block';
          return showByZoom ? 'block' : 'none';
        });
      }

      function activateNode(target){
        g.selectAll('.node').classed('node--active', false);
        if(!target) return;

        d3.select(target).classed('node--active', true);

        const d = d3.select(target).datum();
        const angle = d.x - Math.PI/2;
        const x = Math.cos(angle) * d.y;
        const y = Math.sin(angle) * d.y;

        ring
          .attr('transform', `translate(${x},${y})`)
          .attr('r', d.children ? 14 : (radiusScale(d.data.coverage || 0) + 9))
          .interrupt()
          .transition().duration(140)
          .style('opacity', 1)
          .transition().duration(1000)
          .style('opacity', .75);
      }

      // click interaction
      node.on('click', (ev, d) => {
        ev.stopPropagation();

        if(d.children) {
          // category clicked
          selectedCanon = null;
          updateLeafVisibility(d3.zoomTransform(svg.node()).k);

          document.getElementById('hudLeft').textContent = `Category: ${d.data.name}`;
          activateNode(ev.currentTarget);
          setInspectorCategory(d.data.name);
          return;
        }

        // leaf clicked
        selectedCanon = d.data.canon || null;
        updateLeafVisibility(d3.zoomTransform(svg.node()).k);

        document.getElementById('hudLeft').innerHTML = `Selected: <strong>${esc(d.data.label || d.data.canon)}</strong>`;
        activateNode(ev.currentTarget);
        setInspectorLeaf(d.data);
      });

      // background click reset selection
      svg.on('click', () => {
        document.getElementById('hudLeft').textContent = 'Tip: click a node';
        g.selectAll('.node').classed('node--active', false);
        ring.style('opacity', 0);

        selectedCanon = null;
        updateLeafVisibility(d3.zoomTransform(svg.node()).k);

        resetInspector();
      });

      // Search handling
      const searchIndex = new Map(); // canon -> node selection element
      node.each(function(d){
        if(!d.children && d.data && d.data.canon){
          searchIndex.set(d.data.canon, this);
        }
      });

      function flyToNode(canon){
        const el = searchIndex.get(canon);
        if(!el) return false;
        const d = d3.select(el).datum();

        // zoom a bit more so labels become readable
        const k = 1.75;
        svg.transition().duration(420).call(zoom.scaleTo, k);

        selectedCanon = d.data.canon || null;
        // ensure leaf label shows even before zoom completes
        updateLeafVisibility(k);

        activateNode(el);
        setInspectorLeaf(d.data);
        document.getElementById('hudLeft').innerHTML = `Selected: <strong>${esc(d.data.label || d.data.canon)}</strong>`;
        return true;
      }

      // initial: hide leaf labels until zoom in / selection
      updateLeafVisibility(1.0);

      return { flyToNode };
    }

    // ---------- Inspector ----------
    function resetInspector(){
      document.getElementById('insDef').textContent =
        'Select any node in the radial map to see its canonical key, merged aliases, and dataset evidence.';
      document.getElementById('insKey').textContent = '—';
      document.getElementById('insLabel').textContent = '—';
      document.getElementById('insCat').textContent = '—';
      document.getElementById('insCov').textContent = '—';
      document.getElementById('insAliases').innerHTML = '';
      document.getElementById('insDS').innerHTML = '';
      document.getElementById('insPermalink').setAttribute('href', 'object_class.html');
    }

    function setInspectorCategory(cat){
      document.getElementById('insDef').innerHTML =
        `<strong style="color:var(--oc-ink)">Category</strong><div class="mt-1">Browse objects under <span class="hl">${esc(cat)}</span>.</div>`;
      document.getElementById('insKey').textContent = '—';
      document.getElementById('insLabel').textContent = cat;
      document.getElementById('insCat').textContent = cat;
      document.getElementById('insCov').textContent = '—';
      document.getElementById('insAliases').innerHTML = '';
      document.getElementById('insDS').innerHTML = '';
      document.getElementById('insPermalink').setAttribute('href', 'object_taxonomy.html');
    }

    function setInspectorLeaf(data){
      const aliases = (data.aliases || []).slice().sort((a,b)=>a.localeCompare(b));
      const ds = (data.datasets || []).slice(0, 24);

      document.getElementById('insDef').innerHTML =
        `<strong style="color:var(--oc-ink)">Canonical class definition</strong>
         <div class="mt-1">
           A dataset label mapped to canonical class <span class="hl">${esc(data.label || data.canon)}</span>.
           Canonicalization merges common spelling/format variants to enable cross-dataset benchmarking.
         </div>`;

      document.getElementById('insKey').textContent = data.canon || '—';
      document.getElementById('insLabel').textContent = data.label || data.canon || '—';
      document.getElementById('insCat').textContent = data.category || '—';
      document.getElementById('insCov').textContent = `${data.coverage ?? 0} datasets · ${data.mentions ?? 0} mentions`;

      document.getElementById('insAliases').innerHTML =
        aliases.length
          ? aliases.slice(0, 18).map(a => `<span class="chip">${esc(a)}</span>`).join('')
          : `<span class="text-muted small">—</span>`;

      // ✅ Deep link to dataset detail page
      const toDatasetDetail = (id) => `datasets/detail.html?id=${encodeURIComponent(id)}`;

      document.getElementById('insDS').innerHTML =
        ds.length
          ? ds.map(id => `<span class="chip"><a href="${toDatasetDetail(id)}" title="Open dataset details">${esc(id)}</a></span>`).join('')
          : `<span class="text-muted small">—</span>`;

      const href = `object_class.html?key=${encodeURIComponent(data.canon)}&label=${encodeURIComponent(data.label || data.canon)}`;
      document.getElementById('insPermalink').setAttribute('href', href);
    }

    // ---------- Export ----------
    function downloadText(filename, text){
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function toCSV(rows){
      const escCSV = (v) => {
        const s = String(v ?? '');
        if(/[,"\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
        return s;
      };
      return rows.map(r => r.map(escCSV).join(',')).join('\n');
    }

    // ---------- Init ----------
    let RUNTIME = { flyToNode: null, idx: null };

    async function init(){
      document.getElementById('subtitle').textContent = 'Building canonical index from datasets.json…';

      const datasets = await loadDatasets();
      document.getElementById('statDS').textContent = String(datasets.length);

      const { idx } = buildIndex(datasets);
      document.getElementById('statCanon').textContent = String(idx.size);
      RUNTIME.idx = idx;

      const rootData = buildHierarchy(idx);
      document.getElementById('subtitle').textContent =
        `Derived from ${datasets.length} datasets · ${idx.size} canonical classes · ${CATEGORIES.length + 1} top-level categories`;

      const out = renderRadial(rootData);
      RUNTIME.flyToNode = out.flyToNode;

      // Search: best-effort match by canon + aliases
      const input = document.getElementById('q');
      input.addEventListener('keydown', (e) => {
        if(e.key !== 'Enter') return;
        const needle = canonKey(input.value || '');
        if(!needle) return;

        // Try direct canon
        const direct = singularize(applyAliasMerge(needle));
        if(RUNTIME.flyToNode && RUNTIME.flyToNode(direct)) return;

        // Otherwise find best match by alias overlap
        let best = null;
        for(const rec of idx.values()){
          const hay = (rec.canon + ' ' + Array.from(rec.rawSet).join(' ')).toLowerCase();
          if(hay.includes(needle)){
            if(!best) best = rec;
            else if(rec.dsSet.size > best.dsSet.size) best = rec;
          }
        }
        if(best && RUNTIME.flyToNode) RUNTIME.flyToNode(best.canon);
      });

      // Buttons
      document.getElementById('btnReset').addEventListener('click', () => location.reload());

      document.getElementById('btnExport').addEventListener('click', () => {
        const rows = [['canonical_key','display_label','category','coverage_datasets','mentions','aliases_merged']];
        for(const rec of Array.from(idx.values()).sort((a,b)=>b.dsSet.size-a.dsSet.size)){
          rows.push([
            rec.canon,
            rec.label,
            rec.category,
            rec.dsSet.size,
            rec.mentions,
            Array.from(rec.rawSet).slice(0, 30).join(' | ')
          ]);
        }
        downloadText('openconstruction_object_taxonomy.csv', toCSV(rows));
      });

      resetInspector();
    }

    init().catch(err => {
      console.warn('[object taxonomy] init error:', err);
      document.getElementById('subtitle').textContent = 'Could not load taxonomy. Ensure data/datasets.json exists and is valid.';
      document.getElementById('viz').innerHTML = `<div class="p-4 text-muted">Could not load visualization.</div>`;
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="shortcut icon" href="/favicon.ico">
	<meta name="theme-color" content="#0f2e4b">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenConstruction · Education</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --oc-bg:#fff; --oc-text:#1e2a36; --oc-sub:#6b7b8c;
      --oc-border:#e7edf3; --oc-ink:#0f2e4b; --oc-link:#0b66c3;
      --oc-card:#fff; --oc-shadow:0 8px 24px rgba(15,46,75,.06);
      --oc-radius:14px; --oc-muted:#f6f9fc;
      --oc-brand:#0f2e4b; --oc-accent:#f2a238;

      /* Professional/subdued tag palette */
      --tag-text:#344454; --tag-bg:#f8fafc; --tag-border:#dce3eb;
    }
    html,body{background:var(--oc-bg);color:var(--oc-text)}
    a{color:var(--oc-link)}

    /* ---------- Navbar ---------- */
    .oc-nav{backdrop-filter:saturate(120%) blur(6px)}
	.brand-wordmark{
	  display:flex;
	  flex-direction:column;
	  line-height:1;
	  gap:0;
	  align-items:flex-start;
	  color:#0F2E4B;
	}
	.brand-wordmark .oc-open{
	  font-size:0.75rem;
	  font-weight:400;
	  letter-spacing:0.15em;
	  text-transform:uppercase;
	  opacity:0.7;
	  margin-bottom:-0.1rem;
	}
	.brand-wordmark .oc-sep{display:none}
	.brand-wordmark .oc-construction{
	  font-size:1.35rem;
	  font-weight:700;
	  letter-spacing:-0.01em;
	}
    .oc-logo{height:44px;width:44px}
    .navbar .nav-link.plain{font-weight:700;color:var(--oc-text);padding:.5rem .6rem;}
    .navbar .nav-link.plain:hover,
    .navbar .nav-link.plain.active{color:var(--oc-ink);text-decoration:underline;text-underline-offset:3px;}
    .nav-link.icon-only{line-height:1;padding-top:.375rem;padding-bottom:.375rem}

    /* Docked search */
    .navbar-search{display:none;width:clamp(200px,24vw,320px);}
    .navbar-search .form-control{height:34px;padding:.25rem .75rem;font-size:.875rem;line-height:1.2;border-radius:999px;}
    body.docked .navbar-search{display:flex}
    body.docked #searchDock{display:none}
    @media (min-width: 992px){
      .navbar .container{display:flex;align-items:center}
      .navbar .navbar-collapse{flex-grow:0}
      .navbar .navbar-search{margin-left:.75rem}
    }

    /* ---------- Hero ---------- */
    header.hero{border-bottom:1px solid var(--oc-border);background:#fff;}
    header.hero .content{text-align:center;padding:56px 0 36px;}
    header.hero h1{font-weight:800;color:var(--oc-brand);margin-bottom:.3rem}
    header.hero p{color:var(--oc-sub);margin:0 auto;max-width:72ch}
    .search-input{border-radius:999px;padding:.9rem 1.1rem;max-width:720px;margin:0 auto;box-shadow:inset 0 1px 0 rgba(15,46,75,.05)}

    /* ---------- Filters ---------- */
    .filters{position:sticky;top:86px}
    .facet-list{max-height:280px;overflow:auto;border:1px solid var(--oc-border);border-radius:.5rem;padding:.55rem;background:var(--oc-card)}
    .card .form-label{font-weight:700}

    /* ---------- OER cards ---------- */
    .oer-card{background:var(--oc-card);border:1px solid var(--oc-border);border-radius:var(--oc-radius);box-shadow:var(--oc-shadow);padding:1rem;height:100%}
    .oer-card .left{
      width:240px;           /* wider */
      height:200px;          /* taller */
      flex:0 0 220px;        
      border-radius:12px;
      overflow:hidden;
      background:#f4f7fb;
      border:1px solid var(--oc-border);
      position:relative;
    }
    .oer-card img{width:100%;height:100%;object-fit:cover;object-position:center;display:block}
    .oer-card .title{font-weight:700;color:var(--oc-ink);margin:0 0 .2rem}
    .oer-card .meta{font-size:.85rem;color:var(--oc-sub)}

    /* Submitted-by overlay */
    .oer-card .left .submitted-by{position:absolute;right:6px;bottom:6px;background:rgba(255,255,255,.96);border:1px solid #e0e6ef;border-radius:10px;padding:2px 8px;font-size:.75rem;line-height:1.25;color:#1e2a36;font-weight:500;box-shadow:0 2px 6px rgba(0,0,0,.06);max-width:90%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .oer-card .left .submitted-by a{color:#1e2a36;text-decoration:none}
    .oer-card .left .submitted-by a:hover{text-decoration:underline;color:#0f2e4b}

    /* Titled tag sections */
    .tag-section{ margin-top:.35rem; }
    .tag-title{ font-weight:600; font-size:.8rem; color:var(--oc-sub); margin:0 0 .2rem; }
    .tags{ display:flex; flex-wrap:wrap; gap:.25rem .35rem; }
    .tag{ display:inline-flex; align-items:center; padding:.14rem .48rem; border-radius:999px;
          border:1px solid var(--tag-border); background:var(--tag-bg); color:var(--tag-text);
          font-size:.75rem; line-height:1.1; white-space:nowrap; }

    /* Actions */
    .added-note{margin-left:auto;border-radius:999px;padding:.2rem .6rem;font-size:.78rem;font-weight:600;color:#5f6b77;background:#eff3f6;border:1px solid #e7edf3}

    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap}
    .empty{border:1px dashed var(--oc-border);border-radius:12px;padding:24px;text-align:center;color:var(--oc-sub)}
    .skeleton{position:relative;overflow:hidden;background:var(--oc-muted);border-radius:10px;min-height:120px}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);animation:shimmer 1.1s infinite;mix-blend-mode:overlay}
    @keyframes shimmer{to{transform:translateX(100%)}}

    /* Floating Add button */
    .issue-btn{position:fixed;bottom:20px;right:20px;z-index:1050;background:#0d6efd;color:#fff;padding:12px 20px;border-radius:999px;font-weight:600;font-size:.9rem;box-shadow:0 4px 12px rgba(0,0,0,.25);text-decoration:none;transition:background .2s ease,transform .2s ease}
    .issue-btn:hover{background:#0b5ed7;transform:translateY(-2px);color:#fff;text-decoration:none}

    /* Subscribe bell color */
    .btn-subscribe-icon { background:transparent; border:0; padding:.25rem .4rem; line-height:1; }
    .btn-subscribe-icon svg { fill: var(--oc-accent); }
    .btn-subscribe-icon:hover svg { filter: brightness(1.15); }
  </style>
</head>

<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top oc-nav">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
      <img src="assets/img/icon.png" alt="OpenConstruction logo" height="44" width="44" class="oc-logo">
      <span class="brand-wordmark"><span class="oc-open">Open</span><span class="oc-sep">·</span><span class="oc-construction">Construction</span></span>
    </a>

    <!-- Docked search -->
    <form class="navbar-search ms-3" role="search" onsubmit="return false;">
      <input id="qDock" type="text" class="form-control" placeholder="Search titles, topics, authors …" aria-label="Search OER">
    </form>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExample">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-2">
        <li class="nav-item"><a class="nav-link plain" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link plain" href="dataset.html">Datasets</a></li>
        <li class="nav-item"><a class="nav-link plain" href="models.html">Models</a></li>
        <li class="nav-item"><a class="nav-link plain" href="deployments.html">Use Cases</a></li>
        <li class="nav-item"><a class="nav-link plain active" href="oer.html" aria-current="page">OERs</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link plain dropdown-toggle" href="#" id="ddResources" role="button" data-bs-toggle="dropdown" aria-expanded="false">Resources</a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="ddResources">
            <li><a class="dropdown-item" href="tools.html">Tools</a></li>
            <li><a class="dropdown-item" href="guides.html">Guides</a></li>
            <li><a class="dropdown-item" href="mcp.html">MCP Docs</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link plain" href="contributors.html">Community</a></li>

        <!-- GitHub icon-only link -->
        <li class="nav-item">
          <a class="nav-link px-2 icon-only" href="https://github.com/ruoxinx/OpenConstruction-Datasets" target="_blank" rel="noopener" aria-label="GitHub" title="View on GitHub">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52 0-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.65 7.65 0 0 1 2-.27c.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8"/></svg>
          </a>
        </li>

        <!-- Subscribe bell -->
        <li class="nav-item">
          <button type="button" class="nav-link px-2 icon-only btn-subscribe-icon" data-bs-toggle="modal" data-bs-target="#subscribeModal" aria-label="Subscribe" title="Subscribe">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" aria-hidden="true" class="icon-bell">
              <path d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16zm.5-14a.5.5 0 0 0-1 0 7 7 0 0 0-5.468 6.37c-.084.58-.272 1.204-.653 1.856-.356.617-.879 1.104-1.379 1.357V13h14v-1.417c-.5-.253-1.023-.74-1.379-1.357-.38-.652-.569-1.276-.653-1.856A7 7 0 0 0 8.5 2z"/>
            </svg>
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO -->
<header class="hero">
  <div class="container content">
    <h1 class="display-6 fw-bold">OpenConstruction Educational Resources</h1>
    <p class="lead">Explore <span style="background:linear-gradient(180deg,transparent 60%,rgba(242,162,56,.25) 0);padding:0 .06em;font-weight:700">open educational resources</span> for AEC education</p>
    <div id="searchDock" class="mt-3">
      <input id="q" type="text" class="form-control form-control-lg search-input" placeholder="Search titles, topics, authors …" aria-label="Search OER large">
    </div>
  </div>
</header>

<main class="container my-4">
  <div class="row g-3">
    <!-- Filters -->
    <aside class="col-lg-3">
      <div class="card shadow-sm filters">
        <div class="card-header"><strong>Filters</strong></div>
        <div class="card-body small">
          <div class="mb-3"><label class="form-label">Language</label><div id="filter-language" class="facet-list vstack gap-1"></div></div>
          <div class="mb-3"><label class="form-label">Topics</label><input id="topicSearch" type="text" class="form-control form-control-sm mb-2" placeholder="Search topics…"><div id="filter-topics" class="facet-list vstack gap-1"></div></div>
          <div class="mb-3"><label class="form-label">License</label><input id="licenseSearch" type="text" class="form-control form-control-sm mb-2" placeholder="Search license…"><div id="filter-license" class="facet-list vstack gap-1"></div></div>
          <div class="mb-3"><label class="form-label">Media Format</label><div id="filter-media" class="facet-list vstack gap-1"></div></div>
        </div>
      </div>
    </aside>

    <!-- Results: one card per row -->
    <section class="col-lg-9">
      <div class="toolbar mb-2">
        <div><span id="resultCount" class="fw-semibold">0</span> resources</div>
        <div class="d-flex align-items-center gap-2">
          <label for="sortBy" class="form-label mb-0 small text-muted">Sort by</label>
          <select id="sortBy" class="form-select form-select-sm w-auto">
            <option value="added-desc">Added date ↓</option>
            <option value="added-asc">Added date ↑</option>
            <option value="name-asc">Name A–Z</option>
            <option value="name-desc">Name Z–A</option>
          </select>
        </div>
      </div>

      <!-- vstack = single column -->
      <div id="oerGrid" class="vstack gap-3" aria-live="polite" aria-busy="true">
        <div class="skeleton" style="height:120px"></div>
        <div class="skeleton" style="height:120px"></div>
        <div class="skeleton" style="height:120px"></div>
      </div>

      <div id="emptyState" class="empty d-none mt-4">No results found.</div>
      <div id="errorState" class="empty mt-3 d-none text-danger">Failed to load OER JSON. Please check the file path and JSON format.</div>
    </section>
  </div>
</main>

<footer class="py-4 mt-3 border-top">
  <div class="container oc-container small text-muted text-center">
    <div>© <span id="yearNow"></span> OpenConstruction Open Science Initiative</div>
    <div class="mt-2">
      <small>
        <strong>Disclaimer:</strong> OpenConstruction indexes publicly accessible research metadata and provides
        links to original sources. We do not host or distribute datasets, models, code, or paywalled content.
        All rights remain with the original authors, creators, and publishers.
      </small>
    </div>
  </div>
</footer>

<!-- Floating button: Add new OER -->
<a href="https://github.com/ruoxinx/OpenConstruction-Datasets/issues/new?template=new_OER.yml" class="issue-btn" target="_blank" rel="noopener">Add New OER</a>

<!-- Subscribe Modal -->
<div class="modal fade" id="subscribeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
    <div class="modal-content p-3 rounded-3 shadow">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="m-0 fw-semibold">Subscribe</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="https://github.us5.list-manage.com/subscribe/post?u=12fa0b9a59e8110ba3a89fc76&amp;id=696e3eb0b3&amp;f_id=006fbeedf0" method="post" target="_blank" novalidate>
        <label for="sub-email" class="form-label small text-muted mb-1">Email</label>
        <input type="email" id="sub-email" name="EMAIL" class="form-control mb-2" placeholder="you@university.edu" required>
        <button type="submit" class="btn btn-primary w-100 mt-2">Subscribe</button>
        <div style="position:absolute; left:-5000px" aria-hidden="true"><input type="text" name="b_12fa0b9a59e8110ba3a89fc76_696e3eb0b3" tabindex="-1" value=""></div>
        <p class="small text-muted mt-2 mb-0">We’ll email only when new datasets or models are added. Unsubscribe anytime.</p>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*************************
 * Config + Helpers
 *************************/
const OER_PATHS = ['data/oer.json','../data/oer.json','/data/oer.json'];
const PLACEHOLDER = 'assets/img/oer/_placeholder.png';
const ICON_FALLBACK = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="160" height="120" viewBox="0 0 160 120">
    <rect width="160" height="120" rx="12" fill="#f1f5f9"/>
    <g fill="#0f2e4b" opacity=".6">
      <rect x="24" y="76" width="112" height="8" rx="4"/>
      <rect x="36" y="28" width="28" height="36" rx="6"/>
      <rect x="88" y="44" width="36" height="20" rx="6"/>
    </g>
  </svg>`);

const byId = id => document.getElementById(id);
function uniqSorted(arr){ return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b,undefined,{sensitivity:'base'})); }
function makeCheckbox(id,label,value){
  const wrap = document.createElement('div'); wrap.className='form-check';
  const input=document.createElement('input'); input.className='form-check-input'; input.type='checkbox'; input.id=id; input.value=value;
  const lab=document.createElement('label'); lab.className='form-check-label'; lab.setAttribute('for',id); lab.textContent=label;
  wrap.appendChild(input); wrap.appendChild(lab); return wrap;
}
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function normKey(s){ if(s==null) return ''; return String(s).trim().replace(/[_-]+/g,' ').replace(/\s+/g,' ').toLowerCase(); }
function fmtDateISO(d){ try{ const dt=(d instanceof Date)?d:new Date(d); if(isNaN(+dt)) return null; const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const day=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }catch{return null} }

/*************************
 * State
 *************************/
let OERS=[];
const state={ q:'', sort:'added-desc', langs:new Set(), topics:new Set(), licenses:new Set(), media:new Set() };

/*************************
 * Build facets
 *************************/
function buildFacets(){
  const langVals = uniqSorted(OERS.flatMap(o=> Array.isArray(o.language)?o.language:(o.language?String(o.language).split(/,\s*/):[])).filter(Boolean));
  const topicVals= uniqSorted(OERS.flatMap(o=> Array.isArray(o.topics)?o.topics:(o.topics?String(o.topics).split(/[,/|&+]/):[])).map(s=>s && s.trim()).filter(Boolean));
  const licVals  = uniqSorted(OERS.map(o=>o.license).filter(Boolean));
  const mediaVals= uniqSorted(OERS.flatMap(o=> Array.isArray(o.media)?o.media:(o.media?String(o.media).split(/,\s*/):[])).filter(Boolean));

  const langWrap=byId('filter-language'); if(langWrap){ langWrap.innerHTML=''; langVals.forEach((l,i)=> langWrap.appendChild(makeCheckbox('lg_'+i,l,l))); }
  const topicWrap=byId('filter-topics'); if(topicWrap){ topicWrap.innerHTML=''; topicVals.forEach((t,i)=> topicWrap.appendChild(makeCheckbox('tp_'+i,t,t))); }
  const licWrap=byId('filter-license'); if(licWrap){ licWrap.innerHTML=''; licVals.forEach((l,i)=> licWrap.appendChild(makeCheckbox('lc_'+i,l,l))); }
  const mediaWrap=byId('filter-media'); if(mediaWrap){ mediaWrap.innerHTML=''; mediaVals.forEach((m,i)=> mediaWrap.appendChild(makeCheckbox('md_'+i,m,m))); }
}

/*************************
 * Filter + sort + render
 *************************/
function applyFilters(){
  const q = state.q.trim().toLowerCase();
  let rows = OERS.filter(o=>{
    const text=[o.title,o.provider,o.authors, (o.topics||[]).join(' '), (o.language||[]).join(' '), (o.media||[]).join(' '), o.license,
  o.publisher,
  (o.institutions||[]).join(' '),
].join(' ').toLowerCase();
    if(q && !text.includes(q)) return false;
    if(state.langs.size){
      const langs=new Set((Array.isArray(o.language)?o.language:[o.language]).filter(Boolean).map(normKey));
      let hit=false; for(const l of state.langs){ if(langs.has(normKey(l))) {hit=true; break;} }
      if(!hit) return false;
    }
    if(state.topics.size){
      const tops=new Set((Array.isArray(o.topics)?o.topics:[o.topics]).filter(Boolean).map(normKey));
      let ok=true; for(const t of state.topics){ if(!tops.has(normKey(t))) { ok=false; break; } }
      if(!ok) return false;
    }
    if(state.licenses.size && !state.licenses.has(o.license)) return false;
    if(state.media.size){
      const meds=new Set((Array.isArray(o.media)?o.media:[o.media]).filter(Boolean).map(normKey));
      let hit=false; for(const m of state.media){ if(meds.has(normKey(m))) {hit=true; break;} }
      if(!hit) return false;
    }
    return true;
  });

  switch(state.sort){
    case 'name-asc': rows.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); break;
    case 'name-desc': rows.sort((a,b)=> (b.title||'').localeCompare(a.title||'')); break;
    case 'added-asc': rows.sort((a,b)=> (a._added_ts||0)-(b._added_ts||0)); break;
    default: rows.sort((a,b)=> (b._added_ts||0)-(a._added_ts||0)); // added-desc
  }

  render(rows);
}

/* Build a titled tag section (no license section) */
const sec = (label, arr, cls='') =>
  (Array.isArray(arr) && arr.length)
    ? `<div class="tag-section">
         <div class="tag-title">${label}</div>
         <div class="tags">
           ${arr.map(t => `<span class="tag ${cls}">${t}</span>`).join('')}
         </div>
       </div>`
    : '';

function render(items){
  const grid = byId('oerGrid'); const empty=byId('emptyState'); const err=byId('errorState');
  grid.innerHTML=''; if(err) err.classList.add('d-none');
  byId('resultCount').textContent = items.length;
  if(!items.length){ empty.classList.remove('d-none'); return; } else { empty.classList.add('d-none'); }

  items.forEach(o=>{
    const img = o.image || o.thumbnail || PLACEHOLDER;
    const addedTxt = o._added_fmt ? `Added ${o._added_fmt}` : '';
    const authorsLine = Array.isArray(o.authors) ? o.authors.join(', ') : (o.authors || '');
    const providerOrAuthors = authorsLine || o.provider || '';

    // Build tag sections (add publisher + institutions here)
    const tagsHTML =
      sec('Topics',        o.topics,        'topic') +
      sec('Media',         o.media,         'media') +
      sec('Language',      o.language,      'lang') +
      (o.publisher ? sec('Publisher', [o.publisher], 'publisher') : '') +
      (Array.isArray(o.institutions) && o.institutions.length
        ? sec('Institution(s)', o.institutions, 'inst')
        : '');

    // Build the card
    const card = document.createElement('div');
    card.className = 'oer-card';
    card.innerHTML = `
      <div class="d-flex gap-3 align-items-start">
        <div class="left">
          <img src="${img}" alt="${o.title||'thumbnail'}"
               onerror="this.onerror=null; this.src='${PLACEHOLDER}'; this.setAttribute('onerror', 'this.src=\\'${ICON_FALLBACK}\\'');">
          ${o.contributor || o.contributor_url ? `
            <div class="submitted-by">
              <a href="${o.contributor_url || '#'}" target="_blank" rel="noopener">
                Submitted by <strong>${(o.contributor||'').startsWith('@') ? o.contributor : '@' + (o.contributor||'')}</strong>
              </a>
            </div>` : ''}
        </div>

        <div class="flex-grow-1">
          <h3 class="h6 title mb-1">${o.title || 'Untitled'}</h3>
          <div class="meta mb-1">${providerOrAuthors ? providerOrAuthors + ' • ' : ''}${o.year || '—'}</div>
          ${tagsHTML}
          <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
            ${o.source?`<a class="btn btn-sm btn-primary" href="${o.source}" target="_blank" rel="noopener">View resource</a>`:''}
            ${o._added_fmt?`<span class="added-note ms-auto">${addedTxt}</span>`:''}
          </div>
        </div>
      </div>`;

    grid.appendChild(card);
  });
}

/*************************
 * Wire up controls
 *************************/
function readFacet(containerId, setRef){ setRef.clear(); const root=byId(containerId); if(!root) return; root.querySelectorAll('input[type=checkbox]:checked').forEach(c=> setRef.add(c.value)); }
function attachHandlers(){
  const hero=byId('q'), dock=byId('qDock');
  function sync(to, from){ if(!to||!from) return; to.value=from.value; to.dispatchEvent(new Event('input',{bubbles:true})); }
  const updateQ = debounce(()=>{ state.q = hero.value; if(!document.body.classList.contains('docked')) dock.value = hero.value; applyFilters(); }, 120);
  if(hero){ hero.addEventListener('input', updateQ); }
  if(dock){ dock.addEventListener('input', ()=>{ state.q=dock.value; sync(hero,dock); applyFilters(); }); }

  // Docked search show/hide
  (function(){
    const SHOW_AT=220, HIDE_AT=160; let docked=false;
    function setDock(on){ if(on===docked) return; docked=on; document.body.classList.toggle('docked', on); }
    function onScroll(){ const y=window.scrollY||0; if(!docked && y>SHOW_AT) setDock(true); else if(docked && y<HIDE_AT) setDock(false); }
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
  })();

  // Facets
  const map=[['filter-language',state.langs],['filter-topics',state.topics],['filter-license',state.licenses],['filter-media',state.media]];
  map.forEach(([id,set])=>{ const root=byId(id); if(root){ root.addEventListener('change', ()=>{ readFacet(id,set); applyFilters(); }); }});

  const topicSearch=byId('topicSearch'); if(topicSearch) topicSearch.addEventListener('input', debounce(e=>{
    const q=e.target.value.toLowerCase(); const root=byId('filter-topics');
    root?.querySelectorAll('.form-check').forEach(w=>{ const label=w.querySelector('label').textContent.toLowerCase(); w.style.display = label.includes(q)?'':''; });
  },120));

  const licenseSearch=byId('licenseSearch'); if(licenseSearch) licenseSearch.addEventListener('input', debounce(e=>{
    const q=e.target.value.toLowerCase(); const root=byId('filter-license');
    root?.querySelectorAll('.form-check').forEach(w=>{ const label=w.querySelector('label').textContent.toLowerCase(); w.style.display = label.includes(q)?'':''; });
  },120));

  // Sort
  const sortSel=byId('sortBy'); if(sortSel) sortSel.addEventListener('change', e=>{ state.sort=e.target.value; applyFilters(); });
}

/*************************
 * Load JSON
 *************************/
async function fetchFirst(paths){
  for(const p of paths){
    try{ const res = await fetch(`${p}?v=${Date.now()}`, {cache:'no-store'}); if(res.ok){ return res.json(); } }catch(e){ /* try next */ }
  }
  throw new Error('All OER paths failed');
}
function coerceRow(r){
  const added = r.added || r.added_date || null; const ts = added ? Date.parse(added) : null;
  const lang = Array.isArray(r.language)? r.language : (r.language? String(r.language).split(/,\s*/): []);
  const media= Array.isArray(r.media)? r.media : (r.media? String(r.media).split(/,\s*/): []);
  const topics= Array.isArray(r.topics)? r.topics : (r.topics? String(r.topics).split(/[,/|&+]/).map(s=>s && s.trim()).filter(Boolean) : []);
  const authors = Array.isArray(r.authors) ? r.authors : (r.authors ? String(r.authors).split(/,\s*/) : []);
  return {
    id: r.id || crypto.randomUUID?.() || (r.title || Math.random().toString(36).slice(2)),
    title: r.title || r.name || 'Untitled',
    provider: r.provider || '',
    authors,
    year: (r.year!==undefined && r.year!==null) ? Number(r.year) : '',
    language: lang,
    topics,
    license: r.license || '',
    media,
    image: r.image || r.thumbnail || (r.id ? `assets/img/oer/${r.id}.png` : ''),
    source: r.source || r.url || '',
    contributor: r.contributor || '',
    contributor_url: r.contributor_url || '',
    publisher: r.publisher || r.published_by || '',
    institutions: Array.isArray(r.institutions)
      ? r.institutions
      : (r.institution ? [r.institution] : []),

    _added_ts: (typeof ts==='number' && !isNaN(ts)) ? ts : null,
    _added_fmt: added ? fmtDateISO(added) : null
  };
}

async function loadOER(){
  const grid=byId('oerGrid'), err=byId('errorState');
  try{
    const payload = await fetchFirst(OER_PATHS);
    let raw;
    if (payload && Array.isArray(payload.resources)) {
      raw = payload.resources;
    } else if (Array.isArray(payload)) {
      raw = payload;
    } else if (payload && Array.isArray(payload.oer)) {
      raw = payload.oer;
    } else if (payload && Array.isArray(payload.items)) {
      raw = payload.items;
    } else {
      raw = [];
    }
    OERS = raw.map(coerceRow).filter(o => o && (o.title && o.title !== 'Untitled'));

    const yearNow=byId('yearNow'); if(yearNow) yearNow.textContent=new Date().getFullYear();
    buildFacets(); attachHandlers(); applyFilters();
  }catch(e){ console.error('OER load failed', e); if(grid) grid.innerHTML=''; if(err) err.classList.remove('d-none'); }
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', loadOER); } else { loadOER(); }
</script>
</body>
</html>

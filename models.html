<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Models</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ---------- Design tokens (LIGHT ONLY) ---------- */
    :root{
      --oc-bg:#fff; --oc-text:#1e2a36; --oc-sub:#6b7b8c;
      --oc-border:#e7edf3; --oc-ink:#0f2e4b; --oc-link:#0b66c3;
      --oc-card:#fff; --oc-shadow:0 8px 24px rgba(15,46,75,.06);
      --oc-radius:14px; --oc-muted:#f6f9fc;
      --oc-brand:#0f2e4b; --oc-accent:#f2a238;
    }
    html,body{background:var(--oc-bg); color:var(--oc-text)}
    a{color:var(--oc-link)}
    .oc-card{background:var(--oc-card); border-radius:var(--oc-radius); box-shadow:var(--oc-shadow);}
    .oc-section{margin-top:2rem;}
    .facet-toggle{font-size:.85rem;}
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">Models</h1>

    <div class="row">
      <!-- Sidebar filters -->
      <aside class="col-md-3">
        <div class="oc-card p-3 mb-3">
          <h6>Modalities</h6>
          <div id="filter-modality"></div>
        </div>
        <div class="oc-card p-3 mb-3">
          <h6>Tasks</h6>
          <input type="text" class="form-control form-control-sm mb-2" id="taskSearch" placeholder="Search tasks…">
          <div id="filter-task"></div>
        </div>
        <div class="oc-card p-3 mb-3">
          <h6>Applications</h6>
          <input type="text" class="form-control form-control-sm mb-2" id="appSearch" placeholder="Search applications…">
          <div id="filter-app"></div>
        </div>
        <div class="oc-card p-3 mb-3">
          <h6>Licenses</h6>
          <input type="text" class="form-control form-control-sm mb-2" id="licenseSearch" placeholder="Search licenses…">
          <div id="filter-license"></div>
        </div>
        <div class="oc-card p-3">
          <h6>Year</h6>
          <div class="d-flex align-items-center">
            <input type="number" class="form-control form-control-sm me-2" id="yearRangeMin" style="width:80px">
            <span class="me-2">to</span>
            <input type="number" class="form-control form-control-sm" id="yearRangeMax" style="width:80px">
          </div>
          <div class="mt-2"><input type="range" id="yearSlider" class="form-range"></div>
        </div>
      </aside>

      <!-- Results -->
      <main class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <input type="search" id="q" class="form-control form-control-sm w-50" placeholder="Search models…">
          <select id="sortBy" class="form-select form-select-sm w-auto ms-2">
            <option value="recent">Most recent</option>
            <option value="alpha">A–Z</option>
          </select>
        </div>
        <div id="results" class="row g-3"></div>
      </main>
    </div>
  </div>

  <script src="index.js"></script>
  <script>
  /* ---- Facet display limit + toggle state ---- */
  const CLASS_LIMIT = 5;
  const showAllFacet = { modalities:false, tasks:false, applications:false, licenses:false };

  function ensureToggleButton(containerId, btnId, key, collapsedText, expandedText, renderFn){
    let btn = document.getElementById(btnId);
    if(!btn){
      btn = document.createElement('button');
      btn.type = 'button';
      btn.id = btnId;
      btn.className = 'btn btn-link p-0 facet-toggle';
      const container = byId(containerId);
      if (container) container.insertAdjacentElement('afterend', btn);
    }
    btn.textContent = showAllFacet[key] ? expandedText : collapsedText;
    btn.onclick = ()=>{ showAllFacet[key] = !showAllFacet[key]; renderFn(); };
  }

  function filterByQuery(items, q){
    if(!q) return items;
    const needle = q.toLowerCase();
    return items.filter(it => it.label.toLowerCase().includes(needle));
  }

  function makeCheckboxEl(idPrefix, label, value){
    const wrap = document.createElement('div'); wrap.className = 'form-check';
    const id = `${idPrefix}_${value}`;
    const input = document.createElement('input');
    input.className='form-check-input'; input.type='checkbox'; input.id=id; input.value=value;
    const lab = document.createElement('label');
    lab.className='form-check-label'; lab.setAttribute('for', id); lab.textContent=label;
    wrap.appendChild(input); wrap.appendChild(lab);
    return wrap;
  }

  function renderModalityList(){
    const rootId = 'filter-modality', btnId='toggleModality';
    const root = byId(rootId); if(!root) return;
    root.innerHTML = '';

    let items = window.__FACET__.modalities.slice();
    const limited = showAllFacet.modalities ? items : items.slice(0, CLASS_LIMIT);
    if (!limited.length){ root.innerHTML = '<div class="text-muted small">No modalities</div>'; }
    else limited.forEach(it=> root.appendChild(makeCheckboxEl('m', it.label, it.value)));

    ensureToggleButton(rootId, btnId, 'modalities', 'Show all', 'Show less', renderModalityList);
  }

  function renderTaskList(){
    const rootId = 'filter-task', btnId='toggleTasks';
    const root = byId(rootId); if(!root) return;
    root.innerHTML = '';

    const q = byId('taskSearch')?.value || '';
    let items = filterByQuery(window.__FACET__.tasks.slice(), q).sort((a,b)=> a.label.localeCompare(b.label));

    const limited = (!showAllFacet.tasks && !q) ? items.slice(0, CLASS_LIMIT) : items;
    if (!limited.length){ root.innerHTML = '<div class="text-muted small">No tasks</div>'; }
    else limited.forEach(it=> root.appendChild(makeCheckboxEl('t', it.label, it.value)));

    ensureToggleButton(rootId, btnId, 'tasks', 'Show all', 'Show less', renderTaskList);
  }

  function renderAppList(){
    const rootId = 'filter-app', btnId='toggleApps';
    const root = byId(rootId); if(!root) return;
    root.innerHTML = '';

    const q = byId('appSearch')?.value || '';
    let items = filterByQuery(window.__FACET__.apps.slice(), q).sort((a,b)=> a.label.localeCompare(b.label));

    const limited = (!showAllFacet.applications && !q) ? items.slice(0, CLASS_LIMIT) : items;
    if (!limited.length){ root.innerHTML = '<div class="text-muted small">No applications</div>'; }
    else limited.forEach(it=> root.appendChild(makeCheckboxEl('a', it.label, it.value)));

    ensureToggleButton(rootId, btnId, 'applications', 'Show all', 'Show less', renderAppList);
  }

  function renderLicenseList(){
    const rootId = 'filter-license', btnId='toggleLicenses';
    const root = byId(rootId); if(!root) return;
    root.innerHTML = '';

    const q = byId('licenseSearch')?.value || '';
    let items = filterByQuery(window.__FACET__.licenses.slice(), q).sort((a,b)=> a.label.localeCompare(b.label));

    const limited = (!showAllFacet.licenses && !q) ? items.slice(0, CLASS_LIMIT) : items;
    if (!limited.length){ root.innerHTML = '<div class="text-muted small">No licenses</div>'; }
    else limited.forEach(it=> root.appendChild(makeCheckboxEl('l', it.label, it.value)));

    ensureToggleButton(rootId, btnId, 'licenses', 'Show all', 'Show less', renderLicenseList);
  }

  function buildFacets(){
    // Collect unique values
    MODALITY_MAP = new Map();
    MODELS.forEach(m=>{
      (m.data_modalities || []).forEach(lbl=>{
        const k = normKey(lbl);
        if (!MODALITY_MAP.has(k)) MODALITY_MAP.set(k, lbl);
      });
    });

    window.__FACET__ = {
      modalities: Array.from(MODALITY_MAP.entries()).map(([k,lbl])=>({label:lbl, value:k}))
                      .sort((a,b)=> a.label.localeCompare(b.label)),
      tasks: uniqSorted(MODELS.flatMap(m=>m.tasks||[])).map(t=>({label:t, value:t})),
      apps:  uniqSorted(MODELS.flatMap(m=>m.applications||[])).map(a=>({label:a, value:a})),
      licenses: uniqSorted(MODELS.map(m=>m.license).filter(Boolean)).map(l=>({label:l, value:l}))
    };

    const [minY, maxY] = yearExtent(MODELS);
    const rmin = byId('yearRangeMin'), rmax = byId('yearRangeMax');
    if (rmin && rmax) {
      rmin.min = rmax.min = String(minY);
      rmin.max = rmax.max = String(maxY);
      rmin.value = String(minY); rmax.value = String(maxY);
      state.yMin = minY; state.yMax = maxY;
      updateTrack();
    }

    renderModalityList();
    renderTaskList();
    renderAppList();
    renderLicenseList();
  }

  function attachFacetHandlers(){
    const modEl = byId('filter-modality');
    if (modEl) modEl.addEventListener('change', ()=>{ readFacet('filter-modality', state.modalities); applyFilters(); });

    const taskEl = byId('filter-task');
    if (taskEl) taskEl.addEventListener('change', ()=>{ readFacet('filter-task', state.tasks); applyFilters(); });
    const taskSearch = byId('taskSearch');
    if (taskSearch) taskSearch.addEventListener('input', debounce(()=>{ renderTaskList(); }, 120));

    const appEl = byId('filter-app');
    if (appEl) appEl.addEventListener('change', ()=>{ readFacet('filter-app', state.applications); applyFilters(); });
    const appSearch = byId('appSearch');
    if (appSearch) appSearch.addEventListener('input', debounce(()=>{ renderAppList(); }, 120));

    const licEl = byId('filter-license');
    if (licEl) licEl.addEventListener('change', ()=>{ readFacet('filter-license', state.licenses); applyFilters(); });
    const licenseSearch = byId('licenseSearch');
    if (licenseSearch) licenseSearch.addEventListener('input', debounce(()=>{ renderLicenseList(); }, 120));
  }
  </script>
</body>
</html>

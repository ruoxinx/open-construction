<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Models</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ---------- Design tokens (LIGHT ONLY) ---------- */
    :root{
      --oc-bg:#fff; --oc-text:#1e2a36; --oc-sub:#6b7b8c;
      --oc-border:#e7edf3; --oc-ink:#0f2e4b; --oc-link:#0b66c3;
      --oc-card:#fff; --oc-shadow:0 8px 24px rgba(15,46,75,.06);
      --oc-radius:14px; --oc-muted:#f6f9fc;
      --oc-brand:#0f2e4b; --oc-accent:#f2a238;
    }
    html,body{background:var(--oc-bg); color:var(--oc-text)}

    /* ---------- Layout ---------- */
    .container-narrow{max-width:1100px}
    .container-wide{max-width:1280px}
    .content-wrap{padding-top:1.1rem;padding-bottom:3rem}

    /* ---------- Cards ---------- */
    .oc-card{
      background:var(--oc-card); border:1px solid var(--oc-border);
      border-radius:var(--oc-radius); box-shadow:var(--oc-shadow)
    }
    .oc-card.flat{box-shadow:none}

    /* ---------- Facet area ---------- */
    .facet-card{padding:1rem}
    .facet-title{font-weight:700; font-size:.95rem; letter-spacing:.2px}
    .facet-section{margin-bottom:1rem}
    .facet-search{margin:.35rem 0 .6rem 0}
    .facet-toggle{font-size:.9rem}

    /* ---------- Results ---------- */
    .result-card{padding:1rem}
    .thumb{
      width:160px; height:120px; border-radius:10px; overflow:hidden; background:#f1f5f9; flex:none
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .paper-title{font-weight:800;letter-spacing:.2px;margin-bottom:.25rem}
    .paper-meta{color:var(--oc-sub); font-size:.92rem}
    .paper-abstract{color:#1e2a36; font-size:.96rem}
    .tag{display:inline-block; font-size:.8rem; padding:.15rem .5rem; border-radius:999px; background:#eef5ff; color:#0b66c3; margin-right:.35rem}
    .tag.gray{background:#f1f5f9; color:#2b3a49}

    /* ---------- Docked search ---------- */
    body.docked .search-docked{transform:translateY(0); opacity:1; pointer-events:auto}
    .search-docked{
      position:sticky; top:-1px; z-index:1020; transform:translateY(-10px);
      opacity:0; pointer-events:none; transition:.22s ease; background:rgba(255,255,255,.9);
      backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid var(--oc-border)
    }

    /* ---------- Badges / small UI ---------- */
    .btn-pill{border-radius:999px}

    /* ---------- Brand mark (kept consistent with index) ---------- */
    .brand{display:flex; align-items:center; gap:.5rem; text-decoration:none}
    .brand .logo{
      width:34px;height:34px;border-radius:8px;display:grid;place-items:center;
      background:conic-gradient(from 210deg at 50% 50%, #f2a238, #0f2e4b 55%, #123c62);
      color:#fff;font-weight:800;line-height:1
    }
    .brand .logo span{transform:translateY(1px)}
    .brand-wordmark{
      display:inline-flex;gap:.2rem;align-items:baseline;text-decoration:none;
      color:#0F2E4B;font-weight:700;letter-spacing:.1px;
      font-size:clamp(1.1rem,1.1rem + .4vw,1.35rem)
    }
    .brand-wordmark .oc-open{font-weight:600;opacity:.95}
    .brand-wordmark .oc-sep{opacity:.35;margin:0 .15rem}
    .brand-wordmark .oc-construction{font-weight:800;letter-spacing:.15px}
    .navbar .nav-link.plain{font-weight:700;color:var(--oc-text);padding:.5rem .6rem}
    .navbar .nav-link.plain:hover,.navbar .nav-link.plain.active{
      color:var(--oc-ink);text-decoration:underline;text-underline-offset:3px
    }
    .nav-link.icon-only{line-height:1;padding-top:.375rem;padding-bottom:.375rem}
    .nav-link.icon-only svg{display:block;width:20px;height:20px;color:inherit;opacity:.9}
    .nav-link.icon-only:hover svg{opacity:1}

    /* ---------- Range slider ---------- */
    .range{--track:#e9eef4; --fill:#0b66c3; --knob:#0b66c3}
    .range input[type="range"]{
      -webkit-appearance:none; appearance:none; width:100%; background:transparent; outline:none
    }
    .range input[type="range"]::-webkit-slider-runnable-track{
      height:6px; background:var(--track); border-radius:999px; position:relative
    }
    .range input[type="range"]::-moz-range-track{
      height:6px;background:var(--track);border-radius:999px
    }
    .range input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
      background:var(--knob); margin-top:-6px
    }
    .range .track{height:6px;background:var(--track);border-radius:999px;position:relative}
    .range .fill{position:absolute;top:0;left:0;height:6px;background:var(--fill);border-radius:999px}

    /* ---------- Utilities ---------- */
    .small-muted{font-size:.85rem;color:var(--oc-sub)}
    .grid{display:grid; gap:1rem}
    .grid.cols-2{grid-template-columns: 280px 1fr}
    @media (max-width: 992px){
      .grid.cols-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container-wide">
      <a class="brand" href="index.html">
        <div class="logo"><span>OC</span></div>
        <div class="brand-wordmark">
          <span class="oc-open">Open</span>
          <span class="oc-sep">·</span>
          <span class="oc-construction">Construction</span>
        </div>
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <a class="nav-link plain" href="datasets.html">Datasets</a>
        <a class="nav-link plain active" href="models.html">Models</a>
        <a class="nav-link plain" href="overview.html">Overview</a>
        <a class="nav-link icon-only" href="https://github.com/ruoxinx/open-construction-test" target="_blank" rel="noopener" aria-label="GitHub">
          <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.64 0 8.13c0 3.59 2.29 6.63 5.47 7.7.4.08.55-.18.55-.39 0-.19-.01-.82-.01-1.49-2 .37-2.53-.5-2.69-.96-.09-.24-.48-.96-.82-1.15-.28-.15-.68-.52-.01-.53.63-.01 1.09.58 1.24.82.72 1.2 1.87.86 2.33.66.07-.53.28-.86.51-1.06-1.78-.2-3.64-.91-3.64-4.04 0-.89.31-1.61.82-2.18-.08-.2-.36-1.01.08-2.1 0 0 .67-.22 2.2.83.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.05 2.2-.83 2.2-.83.44 1.09.16 1.9.08 2.1.51.57.82 1.29.82 2.18 0 3.14-1.87 3.83-3.65 4.03.29.26.54.77.54 1.55 0 1.12-.01 2.02-.01 2.29 0 .21.15.47.55.39C13.71 14.76 16 11.72 16 8.13 16 3.64 12.42 0 8 0z"></path></svg>
        </a>
      </div>
    </div>
  </nav>

  <!-- DOCKED SEARCH -->
  <div class="search-docked py-2">
    <div class="container-wide">
      <div class="row g-2 align-items-center">
        <div class="col-md">
          <input id="qDock" type="search" class="form-control form-control-lg" placeholder="Search models, authors, tasks…">
        </div>
        <div class="col-auto"><span class="small-muted">Press Enter to apply</span></div>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <header class="py-4">
    <div class="container-wide">
      <div class="row g-3 align-items-end">
        <div class="col-lg-7">
          <h1 class="mb-2">Model Catalog</h1>
          <p class="small-muted mb-0">Open-source models and papers relevant to AEC vision & multimodal tasks.</p>
        </div>
        <div class="col-lg-5">
          <div class="input-group input-group-lg">
            <input id="q" class="form-control" type="search" placeholder="Search models, authors, tasks…">
            <button class="btn btn-outline-secondary" type="button" id="clearQ">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="content-wrap">
    <div class="container-wide">
      <div class="grid cols-2">
        <!-- FACETS -->
        <aside>
          <div class="oc-card facet-card">
            <div class="facet-section">
              <div class="facet-title">Modalities</div>
              <div id="filter-modality" class="mt-2"></div>
              <!-- Toggle is injected just after the container -->
            </div>

            <div class="facet-section">
              <div class="facet-title">Tasks</div>
              <input id="taskSearch" class="form-control form-control-sm facet-search" placeholder="Filter tasks…">
              <div id="filter-task"></div>
              <!-- Toggle injected -->
            </div>

            <div class="facet-section">
              <div class="facet-title">Applications</div>
              <input id="appSearch" class="form-control form-control-sm facet-search" placeholder="Filter applications…">
              <div id="filter-app"></div>
              <!-- Toggle injected -->
            </div>

            <div class="facet-section">
              <div class="facet-title">Licenses</div>
              <input id="licenseSearch" class="form-control form-control-sm facet-search" placeholder="Filter licenses…">
              <div id="filter-license"></div>
              <!-- Toggle injected -->
            </div>

            <div class="facet-section">
              <div class="facet-title d-flex align-items-center justify-content-between">
                <span>Year</span>
                <span id="yearRangeSelected" class="small-muted"></span>
              </div>
              <div class="range">
                <div class="track position-relative mb-2">
                  <div id="yearRangeTrack" class="fill" style="width:0%"></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <input id="yearRangeMin" type="range" min="2005" max="2025" value="2005" />
                  <input id="yearRangeMax" type="range" min="2005" max="2025" value="2025" />
                </div>
                <div class="d-flex justify-content-between small-muted mt-1">
                  <span id="yearRangeMinVal">—</span>
                  <span id="yearRangeMaxVal">—</span>
                </div>
              </div>
            </div>

            <div>
              <label class="form-label d-flex align-items-center gap-2">
                <span class="facet-title">Sort</span>
                <select id="sortBy" class="form-select form-select-sm ms-auto" style="max-width:220px">
                  <option value="relevance">Relevance</option>
                  <option value="year_desc">Year (new → old)</option>
                  <option value="year_asc">Year (old → new)</option>
                  <option value="title_asc">Title (A → Z)</option>
                </select>
              </label>
            </div>
          </div>
        </aside>

        <!-- RESULTS -->
        <section id="results" class="grid" style="gap:1rem">
          <!-- Cards are injected here -->
        </section>
      </div>
    </div>
  </main>

  <script>
/* ---------------------------
   DATA SOURCE
--------------------------- */
const DATA_URL = 'data/models.json';
let MODELS = [];

/* ---- Thumbnails & placeholders ---- */
const PLACEHOLDER_PNG = 'assets/img/models/_placeholder.png';
const ICON_FALLBACK = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="160" height="120" viewBox="0 0 160 120">
     <rect width="160" height="120" rx="12" fill="#f1f5f9"/>
     <g fill="#0f2e4b" opacity=".6">
       <rect x="24" y="76" width="112" height="8" rx="4"/>
       <rect x="36" y="28" width="28" height="36" rx="6"/>
       <rect x="88" y="44" width="36" height="20" rx="6"/>
     </g>
  </svg>`
);

/* ---------------------------
   State
--------------------------- */
const state = {
  q: '',
  modalities: new Set(),
  tasks: new Set(),
  applications: new Set(),
  licenses: new Set(),
  yMin: 2005,
  yMax: new Date().getFullYear(),
  sort: 'relevance'
};

/* ---------------------------
   Helpers
--------------------------- */
const byId = id => document.getElementById(id);
function uniqSorted(arr){ return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b,undefined,{sensitivity:'base'})); }
function yearExtent(items){
  const ys = items.map(d=>d.year).filter(y=>typeof y==='number' && !isNaN(y));
  if(!ys.length) return [2005, new Date().getFullYear()];
  return [Math.min(...ys), Math.max(...ys)];
}
function makeCheckbox(id, label, value){
  const wrap = document.createElement('div'); wrap.className = 'form-check';
  const input = document.createElement('input'); input.className='form-check-input'; input.type='checkbox'; input.id=id; input.value=value;
  const lab = document.createElement('label'); lab.className='form-check-label'; lab.setAttribute('for', id); lab.textContent=label;
  wrap.appendChild(input); wrap.appendChild(lab);
  return wrap;
}

/* ---- Facet display limit + toggle state (match dataset.html) ---- */
const CLASS_LIMIT = 5;
const showAllFacet = { modalities:false, tasks:false, applications:false, licenses:false };

function ensureToggleButton(containerId, btnId, key, collapsedText, expandedText, renderFn){
  let btn = document.getElementById(btnId);
  if(!btn){
    btn = document.createElement('button');
    btn.type = 'button';
    btn.id = btnId;
    btn.className = 'btn btn-link p-0 facet-toggle';
    const container = byId(containerId);
    if (container) container.insertAdjacentElement('afterend', btn);
  }
  btn.textContent = showAllFacet[key] ? 'Show less' : 'Show all';
  btn.onclick = ()=>{ showAllFacet[key] = !showAllFacet[key]; renderFn(); };
}

function filterByQuery(items, q){
  if(!q) return items;
  const needle = q.toLowerCase();
  return items.filter(it => it.label.toLowerCase().includes(needle));
}

/* ---------------------------
   Data loading & init
--------------------------- */
async function load(){
  const resp = await fetch(DATA_URL);
  MODELS = await resp.json();
  buildFacets();
  attachFacetHandlers();
  applyFilters();
}

/* ---------------------------
   Build facets
--------------------------- */
let MODALITY_MAP = new Map();

function normKey(s){
  if (s == null) return '';
  return String(s).trim().replace(/[_-]+/g,' ').replace(/\s+/g,' ').toLowerCase();
}

function buildFacets(){
  // Collect facets
  MODALITY_MAP = new Map();
  MODELS.forEach(m=>{
    (m.data_modalities || []).forEach(lbl=>{
      const k = normKey(lbl);
      if (!MODALITY_MAP.has(k)) MODALITY_MAP.set(k, lbl);
    });
  });

  window.__FACET__ = {
    modalities: Array.from(MODALITY_MAP.entries()).map(([k,lbl])=>({label:lbl, value:k}))
                    .sort((a,b)=> a.label.localeCompare(b.label)),
    tasks: uniqSorted(MODELS.flatMap(m=>m.tasks||[])).map(t=>({label:t, value:t})),
    apps:  uniqSorted(MODELS.flatMap(m=>m.applications||[])).map(a=>({label:a, value:a})),
    licenses: uniqSorted(MODELS.map(m=>m.license).filter(Boolean)).map(l=>({label:l, value:l}))
  };

  // Year range
  const [minY, maxY] = yearExtent(MODELS);
  const rmin = byId('yearRangeMin'), rmax = byId('yearRangeMax');
  if (rmin && rmax) {
    rmin.min = rmax.min = String(minY);
    rmin.max = rmax.max = String(maxY);
    rmin.value = String(minY); rmax.value = String(maxY);
    state.yMin = minY; state.yMax = maxY;
    updateTrack();
  }

  // Initial facet renders
  renderModalityList();
  renderTaskList();
  renderAppList();
  renderLicenseList();
}

/* ---- Facet renderers (top-5 + toggle) ---- */
function makeCheckboxEl(idPrefix, label, value){
  const wrap = document.createElement('div'); wrap.className = 'form-check';
  const id = `${idPrefix}_${value}`;
  const input = document.createElement('input');
  input.className='form-check-input'; input.type='checkbox'; input.id=id; input.value=value;
  const lab = document.createElement('label');
  lab.className='form-check-label'; lab.setAttribute('for', id); lab.textContent=label;
  wrap.appendChild(input); wrap.appendChild(lab);
  return wrap;
}

function renderModalityList(){
  const rootId = 'filter-modality', btnId='toggleModality';
  const root = byId(rootId); if(!root) return;
  root.innerHTML = '';
  let items = window.__FACET__.modalities.slice();
  const limited = showAllFacet.modalities ? items : items.slice(0, CLASS_LIMIT);
  if (!limited.length){ root.innerHTML = '<div class="text-muted small">No modalities</div>'; }
  else limited.forEach((it,i)=> root.appendChild(makeCheckboxEl('m', it.label, it.value)));
  ensureToggleButton(rootId, btnId, 'modalities', 'Show all', 'Show less', renderModalityList);
}

function renderTaskList(){
  const rootId = 'filter-task', btnId='toggleTasks';
  const root = byId(rootId); if(!root) return;
  root.innerHTML = '';
  const q = byId('taskSearch')?.value || '';
  let items = filterByQuery(window.__FACET__.tasks.slice(), q)
                .sort((a,b)=> a.label.localeCompare(b.label));
  const limited = (!showAllFacet.tasks && !q) ? items.slice(0, CLASS_LIMIT) : items;
  if (!limited.length){ root.innerHTML = '<div class="text-muted small">No tasks</div>'; }
  else limited.forEach((it,i)=> root.appendChild(makeCheckboxEl('t', it.label, it.value)));
  ensureToggleButton(rootId, btnId, 'tasks', 'Show all', 'Show less', renderTaskList);
}

function renderAppList(){
  const rootId = 'filter-app', btnId='toggleApps';
  const root = byId(rootId); if(!root) return;
  root.innerHTML = '';
  const q = byId('appSearch')?.value || '';
  let items = filterByQuery(window.__FACET__.apps.slice(), q)
                .sort((a,b)=> a.label.localeCompare(b.label));
  const limited = (!showAllFacet.applications && !q) ? items.slice(0, CLASS_LIMIT) : items;
  if (!limited.length){ root.innerHTML = '<div class="text-muted small">No applications</div>'; }
  else limited.forEach((it,i)=> root.appendChild(makeCheckboxEl('a', it.label, it.value)));
  ensureToggleButton(root

<script>
(async function(){
  const JSON_URL='data/contributors.json';
  const PAGE_SIZE=9; // keep your 3×3 on desktop

  const $wrap=document.getElementById('occContrib');
  const $grid=document.getElementById('contributorsGrid');
  const $dots=document.getElementById('occDots');
  const $bar=document.getElementById('occBar');
  const $az=document.getElementById('occAZ');
  const $meta=document.getElementById('occAZMeta');
  if(!$wrap||!$grid) return;
  const viewport=$wrap.querySelector('.occ-viewport');

  const byLast=n=>{ if(!n) return ''; const s=n.trim(); if(s.includes(',')) return s.toLowerCase();
    const p=s.split(/\s+/); return (p[p.length-1]+' '+s).toLowerCase(); };
  const chunk=(a,n)=>{ const o=[]; for(let i=0;i<a.length;i+=n) o.push(a.slice(i,i+n)); return o; };
  const initials=name=>(name||'OC').trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('');

  function cardHTML(c){
    const img=c.image?`<img class="headshot" src="${c.image}" alt="">`
                     : `<div class="headshot is-initials">${initials(c.name)}</div>`;
    const body=`<div class="card oc-card person-card h-100">
      <div class="card-body d-flex gap-3">${img}
        <div>
          <h5 class="card-title">${c.name||''}</h5>
          <div class="role">${c.role||''}</div>
          <div class="affil">${c.affiliation||''}</div>
        </div>
      </div></div>`;
    return c.link_url
      ? `<div class="col-md-6 col-xl-4"><a class="text-decoration-none" href="${c.link_url}" target="_blank" rel="noopener">${body}</a></div>`
      : `<div class="col-md-6 col-xl-4">${body}</div>`;
  }

  // Load JSON
  let rows=[];
  try{
    const r=await fetch(JSON_URL,{cache:'no-store'});
    if(!r.ok) throw 0;
    rows=await r.json();
  }catch{
    $grid.innerHTML='<p class="text-muted m-2">Could not load contributors.json</p>'; return;
  }

  // Sort: people by last name A–Z, orgs A–Z; keep orgs after people
  const people=rows.filter(r=>(r.type||'person')!=='org').sort((a,b)=>byLast(a.name).localeCompare(byLast(b.name)));
  const orgs=rows.filter(r=>(r.type||'person')==='org').sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const DATA=people.concat(orgs);

  // Render all once, then paginate
  $grid.innerHTML=DATA.map(cardHTML).join('');
  const ALL_NODES=Array.from($grid.children);
  $grid.remove();

  // Build letter index
  const byLetter=new Map();
  ALL_NODES.forEach(n=>{
    const t=(n.querySelector('.card-title')?.textContent||'').trim();
    const L=(t.match(/[A-Za-z]/)?.[0]||'#').toUpperCase();
    if(!byLetter.has(L)) byLetter.set(L,[]);
    byLetter.get(L).push(n);
  });

  // A–Z toolbar (pills)
  function buildAZ(){
    const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    $az.innerHTML='';
    // All
    const mk=(label,val,enabled=true)=>{
      const b=document.createElement('button');
      b.type='button'; b.className='az-btn'; b.textContent=label; b.dataset.az=val;
      if(!enabled){ b.disabled=true; }
      else{ b.addEventListener('click',()=>setFilter(val)); }
      $az.appendChild(b);
    };
    mk('All','*',true);
    letters.forEach(l=>mk(l,l,byLetter.has(l)));
    if(byLetter.has('#')) mk('#','#',true);
    $az.querySelector('[data-az="*"]').classList.add('active');
  }

  // Carousel
  const track=document.createElement('div'); track.className='occ-track'; viewport.appendChild(track);
  let pool=ALL_NODES.slice(), slides=[], current=1;

  function updateMeta(){
    if(!$meta) return;
    const total=pool.length, start=(current-1)*PAGE_SIZE+1, end=Math.min(current*PAGE_SIZE,total);
    $meta.textContent=total?`Showing ${start}–${end} of ${total}`:'No contributors';
  }
  function buildDots(){
    $dots.innerHTML='';
    slides.forEach((_,i)=>{
      const b=document.createElement('button'); b.type='button'; b.setAttribute('role','tab'); b.setAttribute('aria-label',`Page ${i+1}`);
      if(i+1===current) b.setAttribute('aria-selected','true');
      b.addEventListener('click',()=>goTo(i+1,true)); $dots.appendChild(b);
    });
  }
  function updateDots(){
    Array.from($dots.children).forEach((b,i)=>{ if(i+1===current) b.setAttribute('aria-selected','true'); else b.removeAttribute('aria-selected'); });
  }
  function updateBar(){
    const total=Math.max(1,slides.length), pct=((current-1)/(total-1||1))*100;
    $bar.style.width=(total===1?'100%':pct+'%');
  }
  function goTo(p,animate=true){
    current=Math.max(1,Math.min(p,slides.length||1));
    const xPct=(current-1)*-100;
    track.style.transition=animate?'transform .35s ease':'none';
    track.style.transform=`translateX(${xPct}%)`;
    updateDots(); updateBar(); updateMeta();
  }
  function buildSlides(){
    track.innerHTML=''; slides=[];
    const groups=chunk(pool,PAGE_SIZE);
    groups.forEach(g=>{
      const s=document.createElement('div'); s.className='occ-slide';
      const r=document.createElement('div'); r.className='row g-4';
      g.forEach(n=>r.appendChild(n));
      s.appendChild(r); track.appendChild(s); slides.push(s);
    });
    buildDots(); goTo(1,false);
  }
  function setFilter(letter){
    // toggle active pill
    $az.querySelectorAll('.az-btn').forEach(b=>b.classList.remove('active'));
    const btn=$az.querySelector(`[data-az="${letter}"]`); if(btn) btn.classList.add('active');
    pool=(letter==='*')?ALL_NODES.slice():(byLetter.get(letter)||[]);
    current=1; buildSlides();
  }

  // Buttons + swipe
  $wrap.querySelector('.occ-btn.prev')?.addEventListener('click',()=>goTo(current-1,true));
  $wrap.querySelector('.occ-btn.next')?.addEventListener('click',()=>goTo(current+1,true));
  (function drag(){
    let down=false, startX=0, startTx=0;
    const getTx=()=>{const m=(track.style.transform||'').match(/translateX\((-?\d+(?:\.\d+)?)%\)/);return m?parseFloat(m[1]):0;};
    track.addEventListener('pointerdown',e=>{down=true;startX=e.clientX;startTx=getTx();track.setPointerCapture(e.pointerId);track.style.transition='none';});
    track.addEventListener('pointermove',e=>{if(!down)return;const dx=e.clientX-startX;const pct=(dx/viewport.clientWidth)*100;track.style.transform=`translateX(${startTx+pct}%)`;});
    track.addEventListener('pointerup',()=>{if(!down)return;down=false;const idx=Math.round(-getTx()/100)+1;goTo(idx,true);});
    track.addEventListener('pointercancel',()=>{down=false;});
  })();

  buildAZ(); buildSlides();
})();
</script>

<script>
(async function(){
  // ===== Config (unchanged sizes/layout) =====
  const JSON_URL = 'data/contributors.json';
  const GRID_ID  = 'contributorsGrid';
  const WRAP_ID  = 'occContrib';
  const DOTS_ID  = 'occDots';
  const BAR_ID   = 'occBar';
  const AZ_ID    = 'occAZ';
  const AZ_META  = 'occAZMeta';

  // Keep exactly 9 cards per page on desktop (3x3 look). No visual size changes.
  const PAGE_SIZE = 9;

  // ===== DOM =====
  const $wrap = document.getElementById(WRAP_ID);
  const $grid = document.getElementById(GRID_ID);
  const $dots = document.getElementById(DOTS_ID);
  const $bar  = document.getElementById(BAR_ID);
  const $az   = document.getElementById(AZ_ID);
  const $meta = document.getElementById(AZ_META);
  if(!$wrap || !$grid) return;
  const viewport = $wrap.querySelector('.occ-viewport');

  // ===== Helpers =====
  const byLast = n => {
    if(!n) return '';
    const s=n.trim();
    if(s.includes(',')) return s.toLowerCase();
    const p=s.split(/\s+/), last=p[p.length-1]||'';
    return (last+' '+s).toLowerCase();
  };
  const chunk = (a,n)=>{ const o=[]; for(let i=0;i<a.length;i+=n) o.push(a.slice(i,i+n)); return o; };
  const initials = name => (name||'OC').trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('');

  function cardHTML(c){
    const img = c.image
      ? `<img class="headshot" src="${c.image}" alt="">`
      : `<div class="headshot is-initials">${initials(c.name)}</div>`;
    const inner = `
      <div class="card oc-card person-card h-100">
        <div class="card-body d-flex gap-3">
          ${img}
          <div>
            <h5 class="card-title mb-1">${c.name||''}</h5>
            <div class="role">${c.role||''}</div>
            <div class="affil">${c.affiliation||''}</div>
          </div>
        </div>
      </div>`;
    return c.link_url
      ? `<div class="col-md-6 col-xl-4"><a class="text-decoration-none" href="${c.link_url}" target="_blank" rel="noopener">${inner}</a></div>`
      : `<div class="col-md-6 col-xl-4">${inner}</div>`;
  }

  // ===== Load JSON =====
  let rows=[];
  try{
    const r=await fetch(JSON_URL,{cache:'no-store'});
    if(!r.ok) throw 0;
    rows = await r.json();
  }catch{
    $grid.innerHTML='<p class="text-muted">Could not load contributors.</p>';
    return;
  }

  // Sort: people (A→Z by last name) then orgs (A→Z)
  const people = rows.filter(r => (r.type||'person') !== 'org').sort((a,b)=>byLast(a.name).localeCompare(byLast(b.name)));
  const orgs   = rows.filter(r => (r.type||'person') === 'org').sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const DATA   = people.concat(orgs);

  // Initial render (DOM nodes we will reuse)
  $grid.innerHTML = DATA.map(cardHTML).join('');
  const ALL_NODES = Array.from($grid.children);
  $grid.remove();

  // ===== Build A–Z from current names (Bootstrap buttons only) =====
  const byLetter = new Map();
  ALL_NODES.forEach(el=>{
    const name=(el.querySelector('.card-title')?.textContent||'').trim();
    const first = (name.match(/[A-Za-z]/)?.[0] || '#').toUpperCase();
    if(!byLetter.has(first)) byLetter.set(first, []);
    byLetter.get(first).push(el);
  });

  function buildAZ(){
    if(!$az) return;
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    $az.innerHTML = '';

    // helper to add a button
    const addBtn = (label, value, enabled=true) => {
      const b = document.createElement('button');
      b.type='button';
      b.className = 'btn btn-sm btn-outline-secondary' + (enabled ? '' : ' disabled');
      b.textContent = label;
      b.dataset.az = value;
      if(enabled) b.addEventListener('click',()=>setFilter(value));
      $az.appendChild(b);
    };

    addBtn('All', '*', true);
    letters.forEach(ch => addBtn(ch, ch, byLetter.has(ch)));
    if(byLetter.has('#')) addBtn('#', '#', true);

    // mark All active
    $az.querySelector('[data-az="*"]').classList.add('active');
  }

  // ===== Carousel (uses your existing .occ-track/.occ-slide CSS) =====
  const track = document.createElement('div');
  track.className = 'occ-track';
  viewport.appendChild(track);

  let pool = ALL_NODES.slice(); // current filtered set
  let slides = [], current = 1;

  function updateMeta(){
    if(!$meta) return;
    const total = pool.length;
    const start = (current-1)*PAGE_SIZE + 1;
    const end   = Math.min(current*PAGE_SIZE, total);
    $meta.textContent = total ? `Showing ${start}–${end} of ${total}` : 'No contributors';
  }

  function buildDots(){
    if(!$dots) return; $dots.innerHTML='';
    slides.forEach((_,i)=>{
      const b=document.createElement('button');
      b.type='button';
      b.setAttribute('role','tab');
      b.setAttribute('aria-label',`Page ${i+1}`);
      if(i+1===current) b.setAttribute('aria-selected','true');
      b.addEventListener('click',()=>goTo(i+1,true));
      $dots.appendChild(b);
    });
  }
  function updateDots(){
    if(!$dots) return;
    Array.from($dots.children).forEach((b,i)=>{
      if(i+1===current) b.setAttribute('aria-selected','true');
      else b.removeAttribute('aria-selected');
    });
  }
  function updateBar(){
    if(!$bar) return;
    const total=Math.max(1,slides.length);
    const pct=((current-1)/(total-1||1))*100;
    $bar.style.width = (total===1 ? '100%' : pct+'%');
  }
  function goTo(page, animate=true){
    current = Math.max(1, Math.min(page, slides.length||1));
    const xPct = (current-1) * -100;
    track.style.transition = animate ? 'transform .35s ease' : 'none';
    track.style.transform  = `translateX(${xPct}%)`;
    updateDots(); updateBar(); updateMeta();
  }
  function buildSlides(){
    track.innerHTML=''; slides=[];
    const groups = chunk(pool, PAGE_SIZE);
    groups.forEach(g=>{
      const s=document.createElement('div'); s.className='occ-slide';
      const r=document.createElement('div'); r.className='row g-4';
      g.forEach(n=>r.appendChild(n));
      s.appendChild(r); track.appendChild(s); slides.push(s);
    });
    buildDots(); goTo(1,false);
  }
  function setFilter(letter){
    // update toolbar button states (Bootstrap only)
    $az.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    const btn = $az.querySelector(`[data-az="${letter}"]`);
    if(btn) btn.classList.add('active');

    pool = (letter==='*') ? ALL_NODES.slice() : (byLetter.get(letter) || []);
    current = 1;
    buildSlides();
  }

  // Buttons
  $wrap.querySelector('.occ-btn.prev')?.addEventListener('click',()=>goTo(current-1,true));
  $wrap.querySelector('.occ-btn.next')?.addEventListener('click',()=>goTo(current+1,true));

  // Init
  buildAZ();
  buildSlides();
})();
</script>
